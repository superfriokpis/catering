<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Resumo do Dia — KPIs (Premium)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#f7f9ff 0%,#f2f6ff 40%,#eef4ff 100%);}
    .shadow-premium{box-shadow:0 10px 30px rgba(2,6,23,.12)}
    .chip{box-shadow:0 10px 20px rgba(37,99,235,.12)}
    .tabular-nums{font-variant-numeric:tabular-nums}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;border-width:1px;padding:.5rem .75rem}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useEffect,useMemo,useState,Fragment} = React;

    const META_RULES = {
  // Alvos do tipo ">="
  "ON TIME D-1": { target: 99, operator: ">=", type: "percent" },
  "% On-time (calc)": { target: 99, operator: ">=", type: "percent" },
  "FILL RATE D-1": { target: 99, operator: ">=", type: "percent" },
  "IN FULL D-1": { target: 99, operator: ">=", type: "percent" },
  "Contagem cíclica": { target: 95, operator: ">=", type: "percent" },
  "ILA %": { target: 99, operator: ">=", type: "percent" },
  "IRA %": { target: 99, operator: ">=", type: "percent" },
  "Ocupação": { target: 85, operator: ">=", type: "percent" },

  // Alvos do tipo "<=" (máximos)
  "Perdas (avarias e diferença de estoque)": { target: 8, operator: "<=", type: "percent" },
  "Turnover": { target: 3, operator: "<=", type: "percent" },
  "Absenteísmo": { target: 3, operator: "<=", type: "percent" },

  // Mantidos (se existirem no dataset)
  "Indisponibilidade de Frota (%)": { target: 5, operator: "<=", type: "percent" },
};

    const BLOCKS = [
      { key:"transporte", title:"Transporte", kpisD:[
          "Largada (Total de veículos)",
          "Largada (Veículos que saíram no horario)",
        ], kpisD1:[
          "Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)",
          "Indisponibilidade de Frota (%)","Ocorrências quantidade D-1","Ocorrências em R$ D-1",
          "Custo MOT (armazém e transporte)",
      ]},
      { key:"armazem", title:"Armazém", kpisD:["Ocupação"], kpisD1:[
          "Volume In (tons)","Volume Out (tons)","Volume (tons)","Corte (KG)","Contagem cíclica",
          "Paletes Pendentes","Perdas (avarias e diferença de estoque)",
          "HE armazém e transporte","ILA %","IRA %",
      ]},
      { key:"rh", title:"RH", kpisD:[], kpisD1:["Turnover","Absenteísmo"]},
    ];
    const DAY_METRICS = ["Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Ocupação"];

    const toISO = (d)=>{
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    };
    const parseDateCell = (v)=>{
      if (v==null||v==="") return "";
      if (typeof v==="number" && window.XLSX){
        const d = XLSX.SSF.parse_date_code(v); if(!d) return "";
        return toISO(new Date(d.y,d.m-1,d.d));
      }
      const s=String(v).trim();
      const m=s.match(/^(\d{2})[./](\d{2})[./](\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      const dt=new Date(s); return isNaN(dt)?"":toISO(dt);
    };
    const pct=(v)=> v===""||v==null?"":Number(String(v).replace("%","").replace(",","."));
    const num=(v)=>{
      if (v===null||v===undefined||v==="") return "";
      const n=Number(String(v).replace(/R\$\s?/i,"").replace(/\./g,"").replace(",",".").replace(/%/g,""));
      return Number.isFinite(n)?n:"";
    };
    const fmtNum=(v)=> (v===""||v==null?"":Number(v).toLocaleString("pt-BR"));
    const fmtPct=(v)=>{ if(v===""||v==null) return ""; const n=Number(v); const scaled=(Math.abs(n)<=1? n*100 : n); return `${scaled.toFixed(1).replace(".",",")}%`; };
    const fmtMoney=(v)=> (v===""||v==null?"":Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL",maximumFractionDigits:0}));

    function evalStatus(kpi, rawValue){
      if (rawValue===""||rawValue==null) return {tone:"none", label:"Sem dado"};
      const rule=META_RULES[kpi]; if(!rule) return {tone:"none",label:"—"};
      const v=Number(rawValue); if(!Number.isFinite(v)) return {tone:"none",label:"—"};
      const {target,operator} = rule; const tol = rule.type==="percent"?3:0;
      if (operator!=="<=") { // >=
        if (v>=target) return {tone:"ok",label:"Atingiu"};
        if (v>=target - tol) return {tone:"warn",label:"Quase"};
        return {tone:"bad",label:"Abaixo"};
      } else {
        if (v<=target) return {tone:"ok",label:"Atingiu"};
        if (v<=target + tol) return {tone:"warn",label:"Quase"};
        return {tone:"bad",label:"Acima"};
      }
    }

    function getPrevBusinessDateISO(allDatesISO, refISO){
      const ref=new Date(refISO);
      for(let i=1;i<=10;i++){
        const d=new Date(ref.getFullYear(),ref.getMonth(),ref.getDate()-i);
        const wd=d.getDay(); if(wd===0||wd===6) continue;
        const iso=toISO(d);
        if (allDatesISO.has(iso)) return iso;
      }
      return null;
    }

    function normalizeRow(row){
      const o={}; for (const k in row) o[String(k).trim()] = row[k];
      if (o["Turn over"]!==undefined && o["Turnover"]===undefined){ o["Turnover"]=o["Turn over"]; delete o["Turn over"]; }
      if (o["Indisponibilidade de Frota"]!==undefined && o["Indisponibilidade de Frota (%)"]===undefined) o["Indisponibilidade de Frota (%)"]=o["Indisponibilidade de Frota"];
      o["Data"]=parseDateCell(o["Data"]);
      const PCT=new Set(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
      const INTLIKE=new Set(["Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Horas Extras Armazém","Horas Extras Transporte"]);
      const MONEY=new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
      const TONS=new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
      for (const k of Object.keys(o)){
        if (PCT.has(k)) o[k]=pct(o[k]);
        else if (MONEY.has(k) || INTLIKE.has(k) || TONS.has(k) || k==="Contagem cíclica") o[k]=num(o[k]);
      }
      if (o["Volume (tons)"]===""||o["Volume (tons)"]==null){
        const vin=num(o["Volume In (tons)"])||0, vout=num(o["Volume Out (tons)"])||0;
        o["Volume (tons)"]= (vin>0||vout>0)? (vin+vout) : "";
      }
      const hea=num(o["Horas Extras Armazém"]), het=num(o["Horas Extras Transporte"]);
      if (hea!=="" || het!=="") o["HE armazém e transporte"]=(hea||0)+(het||0);
      const lt=num(o["Largada (Total de veículos)"])||0, ln=num(o["Largada (Veículos que saíram no horario)"])||0;
      o["% On-time (calc)"]= lt>0? (ln/lt)*100 : "";
      return o;
    }

    function isRowAllBlank(o){
      if (!o["Unidade"]||!o["Data"]) return true;
      const keys=["Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica","ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferença de estoque)","HE armazém e transporte","Turnover","Absenteísmo","Custo MOT (armazém e transporte)","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Volume (tons)","Ocupação","Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Indisponibilidade de Frota (%)"];
      for (const k of keys){ const v=o[k]; if (v!=="" && Number(v)!==0) return false; } return true;
    }

    function Toggle({active,children,onClick}){
      return (
        <button onClick={onClick} aria-pressed={active}
                className={`h-9 px-4 rounded-full text-[12px] font-medium border transition
                            ${active ? "bg-white text-blue-700 border-white shadow" : "bg-white/10 text-white border-white/40 hover:bg-white/20"}`}>
          {children}
        </button>
      );
    }

    function UnitChip({label,active,onClick}){
      return (
        <button onClick={onClick} aria-pressed={active}
                className={`px-4 h-9 rounded-full text-[12px] font-semibold shadow
                            ${active ? "bg-blue-600 text-white" : "bg-blue-500/80 text-white hover:bg-blue-500"}`}>
          {label}
        </button>
      );
    }

    function ResumoPremium({ excelUrl = "data/BI Operacional_Catering.xlsx", sheetName = null, initialDate = toISO(new Date()) }){
      const [raw,setRaw] = useState([]);
      const [dateRef,setDateRef] = useState(initialDate);
      const [unitsFilter,setUnitsFilter] = useState([]); // [] => Todas
      const [query,setQuery] = useState("");
      const [onlyBlocks,setOnlyBlocks] = useState({transporte:true, armazem:true, rh:true});
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState("");

      const ALT_URLS = [excelUrl, "./"+excelUrl, "../"+excelUrl, excelUrl.replace("data/","")];
      const queryExcel = () => new URL(location.href).searchParams.get("excel");
      async function fetchArrayBufferWithFallback(){
        const list = [queryExcel(), ...ALT_URLS].filter(Boolean);
        for (const u of list){
          try{ const res = await fetch(u,{cache:"no-store"}); if(res.ok) return await res.arrayBuffer(); }catch(e){}
        }
        throw new Error("Falha ao baixar planilha (404). Use o seletor de arquivo no topo.");
      }

      useEffect(()=>{
        let live=true;
        (async()=>{
          setLoading(true); setError("");
          try{
            const ab = await fetchArrayBufferWithFallback();
            const wb = XLSX.read(ab,{type:"array"});
            const ws = wb.Sheets[sheetName || wb.SheetNames[0]];
            const ref = XLSX.utils.decode_range(ws['!ref']); ref.s.r=Math.max(ref.s.r,2); ref.s.c=Math.max(ref.s.c,1);
            const newRef = XLSX.utils.encode_range(ref);
            let rows = XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
            rows = rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
            if(live) setRaw(rows);
          }catch(err){ if(live) setError(String(err.message||err)); }
          finally{ if(live) setLoading(false); }
        })();
        return ()=>{ live=false; }
      },[excelUrl,sheetName]);

      const units = useMemo(()=> Array.from(new Set(raw.map(r=>r.Unidade))).filter(Boolean).sort(), [raw]);
      const allDates = useMemo(()=> new Set(raw.map(r=>r.Data)), [raw]);
      const d1ISO = useMemo(()=> getPrevBusinessDateISO(allDates, dateRef), [allDates,dateRef]);
      const visibleUnits = useMemo(()=> (unitsFilter.length ? unitsFilter : units), [unitsFilter,units]);

      const dataMatrix = useMemo(()=>{
        const byUnitMetric={};
        const getVal=(unit,metric,iso)=>{
          const list = raw.filter(r=> r.Unidade===unit && r.Data===iso );
          if (!list.length) return "";
          if (["Volume In (tons)","Volume Out (tons)","Corte (KG)","Paletes Pendentes","HE armazém e transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Custo MOT (armazém e transporte)","Volume (tons)"].includes(metric)){
            return list.reduce((s,r)=> s + (Number(r[metric])||0), 0);
          }
          if (metric==="% On-time (calc)"){ let lt=0,ln=0; list.forEach(r=>{ lt+=Number(r["Largada (Total de veículos)"])||0; ln+=Number(r["Largada (Veículos que saíram no horario)"])||0; }); return lt>0? (ln/lt)*100 : ""; }
          const nums = list.map(r=> Number(r[metric]) ).filter(v=> Number.isFinite(v));
          return nums.length? nums.reduce((a,b)=>a+b,0)/nums.length : "";
        };
        for (const u of visibleUnits){
          byUnitMetric[u] = {};
          for (const m of DAY_METRICS) byUnitMetric[u][m] = getVal(u,m,dateRef);
          const others = new Set([ ...BLOCKS.find(b=>b.key==="transporte").kpisD1, ...BLOCKS.find(b=>b.key==="armazem").kpisD1, ...BLOCKS.find(b=>b.key==="rh").kpisD1, "% On-time (calc)" ]);
          for (const m of others) byUnitMetric[u][m] = getVal(u,m,d1ISO);
        }
        return byUnitMetric;
      },[raw,visibleUnits,dateRef,d1ISO]);

      const toggleUnit = (u)=> setUnitsFilter(prev=>{
        const set = new Set(prev);
        if (set.has(u)) set.delete(u); else set.add(u);
        return Array.from(set);
      });

      return (
        <div className="min-h-screen text-[13px] text-slate-900">
          <div className="mx-auto max-w-[1420px] p-4 mt-4 rounded-2xl text-white shadow-premium"
               style={{background:"radial-gradient(1200px 400px at 20% -80%, #5b8bff33 0%, transparent 60%), linear-gradient(100deg, #1e40af, #2563eb 40%, #3b82f6)"}}>
            <div className="flex flex-wrap items-center justify-between gap-4">
              <div className="min-w-[280px]">
                <h1 className="text-xl font-extrabold tracking-tight">Resumo do Dia — KPIs</h1>
                <p className="text-xs/5 opacity-95">Largada &amp; Ocupação do <b>Dia (D)</b>. Demais KPIs por <b>D-1 útil</b>. Filtros por unidade e busca por KPI.</p>
                <div className="flex flex-wrap gap-2 mt-3">
                  {DAY_METRICS.map(m=> (
                    <span key={m} className="chip inline-flex items-center gap-2 rounded-full bg-white text-slate-900 text-[11px] font-semibold px-3 py-2">
                      <span className="w-2 h-2 rounded-full bg-white/70 border border-white"></span>{m} (D)
                    </span>
                  ))}
                  <span className="inline-flex items-center gap-2 rounded-full bg-white/15 border border-white/30 text-white text-[11px] font-medium px-3 py-2">Linhas (D-1): demais KPIs</span>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <label className="flex items-center gap-2 text-xs">
                  <span className="opacity-90">Data</span>
                  <input type="date" value={dateRef} onChange={e=>setDateRef(e.target.value)}
                         className="h-9 rounded-xl border border-white/40 bg-white/10 text-white px-3 backdrop-blur-sm placeholder-white/70"/>
                </label>
                <button onClick={()=>setDateRef(toISO(new Date()))}
                        className="h-9 rounded-xl border border-white/40 bg-white/15 px-3 text-xs hover:bg-white/25">Hoje</button>
                <div className="w-px h-9 bg-white/30" />
                <div className="flex items-center gap-2">
                  <Toggle active={!!onlyBlocks.transporte} onClick={()=>setOnlyBlocks(s=>({...s,transporte:!s.transporte}))}>Transporte</Toggle>
                  <Toggle active={!!onlyBlocks.armazem} onClick={()=>setOnlyBlocks(s=>({...s,armazem:!s.armazem}))}>Armazém</Toggle>
                  <Toggle active={!!onlyBlocks.rh} onClick={()=>setOnlyBlocks(s=>({...s,rh:!s.rh}))}>RH</Toggle>
                </div>
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-2 mt-3 text-xs">
              <div className="text-white/90"><b>Data:</b> {new Date(dateRef).toLocaleDateString("pt-BR")} • <b>D-1 útil:</b> {d1ISO? new Date(d1ISO).toLocaleDateString("pt-BR"): "—"}</div>
              <div className="text-white/90">• <b>Unidades:</b> {useMemo(()=>Array.from(new Set(raw.map(r=>r.Unidade))).length,[raw]) || "—"}</div>
            </div>
          </div>

          <div className="mx-auto max-w-[1420px] mt-3 px-4 flex items-center gap-2 flex-wrap">
            <UnitChip label="Todas" active={unitsFilter.length===0} onClick={()=>setUnitsFilter([])}/>
            {useMemo(()=>units, [units]).map(u=> (
              <UnitChip key={u} label={u} active={unitsFilter.includes(u)} onClick={()=>toggleUnit(u)}/>
            ))}
            <div className="ml-auto flex items-center gap-2">
              <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Buscar KPI…"
                     className="h-9 rounded-full border border-slate-300 bg-white px-3 min-w-[220px] text-[12px]"/>
              <label className="btn bg-white text-blue-700 border-slate-300 cursor-pointer">
                <input id="fileXlsx" type="file" accept=".xlsx" className="hidden"/>
                Carregar XLSX
              </label>
            </div>
          </div>

          <div className="mx-auto max-w-[1420px] px-4 mt-4">
            {!!error && <div className="rounded-xl border border-rose-300 bg-rose-50 text-rose-700 p-3 text-sm">{error}</div>}
            {loading ? (
              <div className="rounded-xl border border-slate-200 bg-white p-6 shadow-premium text-slate-600 text-sm">Carregando…</div>
            ) : (
              <div className="rounded-2xl border border-slate-200 bg-white shadow-premium">
                <div className="px-4 py-3 border-b border-slate-200 text-slate-600 text-xs">Dica: clique no título da coluna para fixar a primeira coluna e navegar horizontalmente.</div>
                <div className="overflow-auto p-2">
                  <table className="w-full border-separate border-spacing-0">
                    <thead>
                      <tr>
                        <th className="sticky left-0 z-20 bg-gradient-to-r from-white to-white/95 text-left px-3 py-3 text-[11px] font-bold text-slate-800 border-b border-slate-200 min-w-[260px] text-center">KPI</th>
                        {visibleUnits.map(u=> (
                          <th key={u} className="sticky top-0 z-10 bg-gradient-to-b from-blue-600 to-blue-700 text-white px-3 py-3 text-[11px] border-l border-white/20 text-center">{u}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {BLOCKS.filter(b=>onlyBlocks[b.key]).map(b=>(
                        <Fragment key={b.key}>
                          <tr>
                            <td colSpan={visibleUnits.length + 1}
                                className="bg-slate-50 text-slate-700 font-semibold text-xs px-3 py-2 border-y border-slate-200">{b.title} — (D)</td>
                          </tr>
                          {b.kpisD.filter(k=>k.toLowerCase().includes(query.toLowerCase())).map(kpi=> (
                            <tr key={kpi} className="hover:bg-slate-50/60">
                              <th className="sticky left-0 bg-gradient-to-r from-white to-white/95 text-left px-3 py-2 text-[12px] font-semibold text-slate-800 border-b border-slate-200 text-center">{kpi}</th>
                              {visibleUnits.map(u=>{
                                const v = (dataMatrix?.[u]||{})[kpi]; const s = evalStatus(kpi,v);
                                return <td key={u} className="text-right px-3 py-2 border-b border-slate-200 align-middle whitespace-nowrap"><ValueCell kpi={kpi} value={v} status={s}/></td>;
                              })}
                            </tr>
                          ))}
                          <tr>
                            <td colSpan={visibleUnits.length + 1}
                                className="bg-indigo-50/80 text-indigo-800 font-semibold text-xs px-3 py-2 border-y border-slate-200">{b.title} — (D-1 útil)</td>
                          </tr>
                          {b.kpisD1.filter(k=>k.toLowerCase().includes(query.toLowerCase())).map(kpi=> (
                            <tr key={kpi} className="hover:bg-slate-50/60">
                              <th className="sticky left-0 bg-gradient-to-r from-white to-white/95 text-left px-3 py-2 text-[12px] font-semibold text-slate-800 border-b border-slate-200 text-center">{kpi}</th>
                              {visibleUnits.map(u=>{
                                const v = (dataMatrix?.[u]||{})[kpi]; const s = evalStatus(kpi,v);
                                return <td key={u} className="text-right px-3 py-2 border-b border-slate-200 align-middle whitespace-nowrap"><ValueCell kpi={kpi} value={v} status={s}/></td>;
                              })}
                            </tr>
                          ))}
                        </Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>

          <div className="mx-auto max-w-[1420px] px-4 py-6 flex items-center justify-between text-xs text-slate-500">
            <div>Resumo premium — React + Tailwind + XLSX</div>
            <button className="px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50"
                    onclick="if(history.length>1) history.back(); else window.close();">Voltar</button>
          </div>
        </div>
      );
    }

    function ValueCell({kpi,value,status}){
      const isMoney = kpi==="Ocorrências em R$ D-1" || kpi==="Custo MOT (armazém e transporte)";
      const isPct = ["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Indisponibilidade de Frota (%)","Ocupação","% On-time (calc)","Contagem cíclica"].includes(kpi);
      const text = isMoney ? fmtMoney(value) : isPct ? fmtPct(value) : fmtNum(value);
      const toneDot = { none: "bg-slate-300", ok: "bg-emerald-500", warn: "bg-amber-500", bad: "bg-rose-500" }[status.tone] || "bg-slate-300";
      return (
        <div className="flex items-center justify-end gap-2">
          <span className={`inline-block w-2 h-2 rounded-full ${toneDot}`} title={status.label || ""} aria-label={status.label || ""}></span>
          <span className="tabular-nums">{text}</span>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ResumoPremium />);
  </script>
</body>
</html>
