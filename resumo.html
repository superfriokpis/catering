<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Resumo do Dia — KPIs</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --brand-primary:#1d4ed8; --brand-primary-dark:#1e40af; --brand-primary-light:#eff5ff;
  --border:#e2e8f0; --surface:#ffffff; --muted:#f8fafc; --text:#0f172a; --sub:#475569;
  --radius:.8rem; --shadow:0 1px 2px rgba(0,0,0,.06);
}
html,body{background:#f8fafc;color:var(--text);font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1400px;margin-inline:auto;padding:18px;}
.header{background:linear-gradient(90deg,var(--brand-primary-dark),var(--brand-primary));color:#fff;border-radius:18px;padding:16px 18px;box-shadow:var(--shadow);}
.header h1{font-size:18px;font-weight:700}
.header p{font-size:12px;opacity:.9}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
.toolbar label{font-size:12px}
.toolbar input[type=date]{border:1px solid #e2e8f0;border-radius:10px;padding:6px 10px;font-size:14px;color:#0f172a;background:#fff;height:36px}
.btn{border:1px solid #e2e8f0;background:#fff;border-radius:10px;padding:6px 10px;font-size:13px}
.card{background:#fff;border:1px solid #e2e8f0;border-radius:18px;box-shadow:var(--shadow)}
.table-wrap{overflow:auto}
table.kpi{width:100%;border-collapse:separate;border-spacing:0}
table.kpi thead th{position:sticky;top:0;background:var(--brand-primary-dark);color:#fff;font-size:12px;padding:10px;text-align:center}
table.kpi thead th:first-child{position:sticky;left:0;z-index:3}
table.kpi tbody th{position:sticky;left:0;background:#fff;text-align:left;font-weight:700;color:#0f172a;border-right:1px solid #e2e8f0}
table.kpi tbody td, table.kpi tbody th{padding:10px 12px;border-bottom:1px solid #e2e8f0;font-size:12px;white-space:nowrap}
table.kpi tbody tr:hover td{background:#f1f5fe}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #e2e8f0;font-size:12px}
.badge strong{color:#1d4ed8}
.legend{display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:12px;color:#475569}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h1>Resumo do Dia — KPIs (Matriz)</h1>
          <p>Visão por unidade, com Largada/Largada no horário/Ocupação do dia (D) e demais KPIs do D‑1 útil.</p>
        </div>
        <div class="toolbar">
          <label>Data
            <input id="dateRef" type="date"/>
          </label>
          <button id="btnHoje" class="btn" type="button">Hoje</button>
          <button id="btnVoltar" class="btn" type="button">Voltar para o Dashboard</button>
        </div>
      </div>
      <div class="legend mt-3">
        <span id="lblD" class="badge">Do dia (D): <strong>Largada Total</strong>, <strong>Largada no horário</strong>, <strong>Ocupação</strong></span>
        <span id="lblD1" class="badge">Dia útil anterior (D‑1): Demais KPIs</span>
      </div>
    </div>

    <div class="card mt-4">
      <div class="p-3 border-b border-slate-200">
        <div class="small"><strong>Data de referência:</strong> <span id="infoData">—</span> • <strong>D‑1 útil:</strong> <span id="infoDataD1">—</span></div>
      </div>
      <div class="table-wrap p-2">
        <table class="kpi">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const EXCEL_URL = "data/BI Operacional_Catering.xlsx";
const EXCEL_SHEET = null; // primeira aba

/* ===== Utils (compatíveis com seu dashboard atual) ===== */
const toISODateLocal=(y,m,d)=>`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
function parseDateRaw(s){
  if(!s) return new Date('invalid');
  const iso=String(s).match(/^(\\d{4})-(\\d{2})-(\\d{2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
  const dmY=String(s).match(/^(\\d{2})[./](\\d{2})[./](\\d{4})$/); if(dmY) return new Date(+dmY[3],+dmY[2]-1,+dmY[1]);
  return new Date(s);
}
function asNumber(v){
  if(v===null||v===undefined) return '';
  const s=String(v).trim();
  if(s==='') return '';
  const n=Number(s.replace(/R\\$\\s?/i,'').replace(/\\./g,'').replace(',','.').replace(/%/g,''));
  return Number.isFinite(n)?n:'';
}
function normPct(v){
  if(v===''||v==null) return '';
  let n=Number(String(v).replace('%','').replace(/\\s/g,'').replace(',','.'));
  if(!Number.isFinite(n)) return '';
  if(n>0 && n<=1) return n*100;
  if(n<=100) return n;
  while(n>100) n/=10;
  return n;
}
function asDateISO(v){
  if(v==null||v==='') return '';
  if(typeof v==='number'){
    const d=XLSX.SSF.parse_date_code(v); if(!d) return '';
    return toISODateLocal(d.y,d.m,d.d);
  }
  const s=String(v).trim();
  const m=s.match(/^(\\d{2})[./](\\d{2})[./](\\d{4})$/); if(m) return toISODateLocal(+m[3],+m[2],+m[1]);
  const dt=new Date(s); return isNaN(dt)?'':toISODateLocal(dt.getFullYear(),dt.getMonth()+1,dt.getDate());
}
const PCT=new Set(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
const INTLIKE=new Set(["Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Horas Extras Armazém","Horas Extras Transporte"]);
const MONEY=new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
const TONS=new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
function normalizeRow(row){
  const o={};
  for(const k in row){ const key=String(k).trim(); o[key]=row[k]; }
  if(o["Turn over"]!==undefined && o["Turnover"]===undefined){ o["Turnover"]=o["Turn over"]; delete o["Turn over"]; }
  if(o["Indisponibilidade de Frota"]!==undefined && o["Indisponibilidade de Frota (%)"]===undefined) o["Indisponibilidade de Frota (%)"]=o["Indisponibilidade de Frota"];
  o["Data"]=asDateISO(o["Data"]);
  // números
  Object.keys(o).forEach(k=>{
    if(PCT.has(k)) o[k]=normPct(o[k]);
    else if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k) || k==="Contagem cíclica"){
      const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n;
    }
  });
  // Volume total se não vier pronto
  if(o["Volume (tons)"]===''||o["Volume (tons)"]==null){
    const vin=asNumber(o["Volume In (tons)"])||0, vout=asNumber(o["Volume Out (tons)"])||0;
    o["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):'';
  }
  // HE total se vierem separadas
  const hea=asNumber(o["Horas Extras Armazém"]); const het=asNumber(o["Horas Extras Transporte"]);
  if(hea!=='' || het!==''){ o["HE armazém e transporte"]=(hea||0)+(het||0); }
  // On-time calc
  const lt=asNumber(o["Largada (Total de veículos)"])||0, ln=asNumber(o["Largada (Veículos que saíram no horario)"])||0;
  o["% On-time (calc)"]=lt>0?(ln/lt)*100:'';
  return o;
}
function isRowAllBlank(o){
  if(!o["Unidade"]||!o["Data"]) return true;
  const keys = [
    "Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica","ILA %","IRA %",
    "Paletes Pendentes","Perdas (avarias e diferença de estoque)","HE armazém e transporte",
    "Turnover","Absenteísmo","Custo MOT (armazém e transporte)","Largada (Total de veículos)",
    "Largada (Veículos que saíram no horario)","Volume (tons)","Ocupação","Reentrega",
    "ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorrências quantidade D-1","Ocorrências em R$ D-1",
    "Indisponibilidade de Frota (%)"
  ];
  for(const k of keys){ const v=o[k]; if(v!=='' && Number(v)!==0) return false; }
  return true;
}
function fmtPct(v){ return (v===''||v==null)?'':(Number(v).toFixed(1).replace('.',',')+'%'); }
function fmtMoney(v){ return (v===''||v==null)?'':Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}); }
function fmtNum(v){ return (v===''||v==null)?'':Number(v).toLocaleString('pt-BR'); }

/* ===== Carregamento ===== */
let DATA=[];
async function loadExcelFromRepo(){
  const res = await fetch(EXCEL_URL,{cache:"no-store"});
  if(!res.ok) throw new Error("Falha ao baixar planilha ("+res.status+")");
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const ref = XLSX.utils.decode_range(ws['!ref']); ref.s.r=Math.max(ref.s.r,2); ref.s.c=Math.max(ref.s.c,1);
  const newRef=XLSX.utils.encode_range(ref);
  let rows = XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
  rows = rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
  DATA = rows;
}

/* ===== Datas D e D-1 útil ===== */
function prevBusinessISO(refISO){
  if(!refISO) return null;
  const ref=parseDateRaw(refISO);
  for(let i=1;i<=10;i++){
    const d=new Date(ref.getFullYear(),ref.getMonth(),ref.getDate()-i);
    const wd=d.getDay(); if(wd===0||wd===6) continue;
    const iso=toISODateLocal(d.getFullYear(),d.getMonth()+1,d.getDate());
    const has = DATA.some(r=> r.Data===iso );
    if(has) return iso;
  }
  return null;
}

/* ===== Matriz ===== */
const dayMetrics = [
  "Largada (Total de veículos)",
  "Largada (Veículos que saíram no horario)",
  "Ocupação"
];
const d1Metrics = [
  "Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica",
  "ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferença de estoque)",
  "HE armazém e transporte","Turnover","Absenteísmo","Custo MOT (armazém e transporte)",
  "Volume (tons)","Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1",
  "Ocorrências quantidade D-1","Ocorrências em R$ D-1","Indisponibilidade de Frota (%)"
];

function unitsSorted(){
  return Array.from(new Set(DATA.map(r=>r.Unidade))).filter(Boolean).sort();
}

function valueFor(unit, metric, iso, mode){
  // mode: 'D' usa iso; 'D1' usa d1ISO (passado)
  const list = DATA.filter(r=> r.Unidade===unit && r.Data===iso );
  if(!list.length) return '';
  // soma ou média conforme métrica
  if(metric==="% On-time (calc)"){
    let lt=0, ln=0; list.forEach(r=>{ lt+=Number(r["Largada (Total de veículos)"])||0; ln+=Number(r["Largada (Veículos que saíram no horario)"])||0; });
    return lt>0? (ln/lt)*100 : '';
  }
  if(["Volume In (tons)","Volume Out (tons)","Corte (KG)","Paletes Pendentes","HE armazém e transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Custo MOT (armazém e transporte)","Volume (tons)"].includes(metric)){
    return list.reduce((s,r)=> s + (Number(r[metric])||0), 0);
  }
  // médias
  const nums = list.map(r=> Number(r[metric]) ).filter(v=> Number.isFinite(v));
  return nums.length? nums.reduce((a,b)=>a+b,0)/nums.length : '';
}

function renderMatrix(iso){
  const d1 = prevBusinessISO(iso);
  document.getElementById('infoData').textContent = iso.split('-').reverse().join('/');
  document.getElementById('infoDataD1').textContent = d1? d1.split('-').reverse().join('/') : '—';

  const units = unitsSorted();
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');

  // Cabeçalho
  const trh = document.createElement('tr');
  const th0 = document.createElement('th'); th0.textContent='KPIs'; th0.style.minWidth='260px'; trh.appendChild(th0);
  units.forEach(u=>{ const th=document.createElement('th'); th.textContent=u; trh.appendChild(th); });
  thead.innerHTML=''; thead.appendChild(trh);

  // Linhas D (Largada/Largada no horário/Ocupação)
  const rowsOrder = [...dayMetrics.map(m=>({m,mode:'D'})), ...d1Metrics.map(m=>({m,mode:'D1'}))];
  const frag = document.createDocumentFragment();

  rowsOrder.forEach(({m,mode})=>{
    const tr=document.createElement('tr');
    const th=document.createElement('th');
    th.innerHTML = (mode==='D' ? '( D ) ' : '( D‑1 ) ') + m;
    tr.appendChild(th);
    units.forEach(u=>{
      const td=document.createElement('td');
      const val = valueFor(u, m, mode==='D' ? iso : d1, mode);
      let txt='';
      if(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"].includes(m)) txt = val===''?'':fmtPct(val);
      else if(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"].includes(m)) txt = fmtMoney(val);
      else txt = fmtNum(val);
      td.textContent = (txt===''?'—':txt);
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });

  tbody.innerHTML='';
  tbody.appendChild(frag);
}

/* ===== Bootstrap ===== */
async function init(){
  try{
    await loadExcelFromRepo();
  }catch(e){
    console.warn(e);
  }
  // Data padrão = hoje (mas se não houver dados de hoje, o usuário pode alterar)
  const today = new Date();
  const isoToday = toISODateLocal(today.getFullYear(),today.getMonth()+1,today.getDate());
  dateRef.value = isoToday;
  renderMatrix(isoToday);
}

const dateRef = document.getElementById('dateRef');
document.getElementById('btnHoje').addEventListener('click',()=>{
  const t=new Date(); const iso=toISODateLocal(t.getFullYear(),t.getMonth()+1,t.getDate());
  dateRef.value=iso; renderMatrix(iso);
});
document.getElementById('btnVoltar').addEventListener('click',()=>{
  // tenta ir para a página principal (mesmo host) / index.html
  location.href = location.origin + location.pathname.replace(/[^/]+$/,'') + 'index.html#arm';
});
dateRef.addEventListener('change',()=>{
  const iso = dateRef.value;
  if(iso) renderMatrix(iso);
});

init();
</script>
</body>
</html>
