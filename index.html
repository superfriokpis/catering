<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard - Kpis</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{--azul:#0b3a8a;--azul-esc:#082a66;--azul-claro:#e8f0ff;--borda:#cfe0ff;--grad-a:#2b6cff;--grad-b:#5bbcff}
html,body{background:#fff;color:#0f172a}
.brand-grad{background:linear-gradient(90deg,var(--azul),#1673ff)}
.tab,.pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:.44rem .9rem;border-radius:999px;border:1px solid var(--borda);background:#fff;color:#0b3a8a;transition:.2s;white-space:nowrap;text-decoration:none}
.tab:hover,.pill:hover{background:#f7fbff}
.tab[aria-current="page"],.pill[aria-pressed="true"]{background:linear-gradient(135deg,var(--grad-a),var(--grad-b));color:#fff;border:0;box-shadow:0 4px 12px rgba(30,94,220,.25)}
.tab svg{width:14px;height:14px;color:currentColor}
.tab[aria-current="page"] svg{filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
.btn{font-size:12px;border:1px solid var(--borda);background:#fff;color:#0b3a8a;padding:.44rem .75rem;border-radius:.55rem}
.btn:hover{background:#f3f7ff}
.btn-primary{background:var(--azul);color:#fff;border-color:var(--azul)}
.combo-nav{display:flex;align-items:center;gap:8px;overflow-x:auto;padding:6px 0 4px}
#unitsBar{display:flex;gap:8px;margin-left:12px}
#cards{display:flex !important;gap:12px;align-items:stretch;overflow:visible;--cardW:180px}
#cards>div{width:var(--cardW);min-width:96px}
.kpi-card{border-radius:12px;padding:.60rem .65rem}
.kpi-card .text-lg{font-size:clamp(13px,1.5vw,18px)}
.ok{border-left:6px solid #16a34a;background:#dcfce7}
.warn{border-left:6px solid #f59e0b;background:#fef3c7}
.bad{border-left:6px solid #ef4444;background:#fee2e2}
.neutral{border-left:6px solid #94a3b8;background:#f1f5f9}
table.kpi{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0}
table.kpi th,table.kpi td{padding:.40rem .45rem;font-size:11px;line-height:1.15;text-align:center;vertical-align:middle}
table.kpi thead th{position:sticky;top:0;z-index:1;background:var(--azul-esc);color:#fff}
table.kpi tbody tr td{border-bottom:1px solid #e5edff}
.col-unidade{min-width:100px}.col-data{min-width:110px}.col-num{min-width:80px}
#secRH table.kpi th,#secRH table.kpi td,#secTransp table.kpi th,#secTransp table.kpi td{font-size:clamp(10px,0.9vw,12px);padding:clamp(.22rem,.5vw,.38rem) clamp(.28rem,.6vw,.45rem)}
#secRH .col-unidade,#secTransp .col-unidade{min-width:90px}
#secRH .col-data,#secTransp .col-data{min-width:96px}
#secRH .col-num,#secTransp .col-num{min-width:66px}
@media (max-width:1366px){
  #secRH table.kpi th,#secRH table.kpi td,#secTransp table.kpi th,#secTransp table.kpi td{font-size:clamp(9px,0.85vw,11px)}
  #secRH .col-num,#secTransp .col-num{min-width:58px}
}
.legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:.35rem}
.dot-ok{background:#16a34a}.dot-warn{background:#f59e0b}.dot-bad{background:#ef4444}

/* =========================
   AJUSTES PREMIUM DOS CARDS
   (somente tipografia/espacÃßamento dos KPIs)
   ========================= */
#cards > div{
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  padding:.48rem .56rem;         /* compact */
  border-radius:14px;
}
#cards > div .text-[12px]{       /* t√≠tulo do card */
  font-family:"Inter","Segoe UI",system-ui,-apple-system,Roboto,"Helvetica Neue",Arial,sans-serif;
  font-size:11px;
  line-height:1.15;
  font-weight:500;
  letter-spacing:-0.2px;
  color:#475569;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#cards > div .text-lg{           /* n√∫mero principal */
  font-family:"Inter","Segoe UI",system-ui,-apple-system,Roboto,"Helvetica Neue",Arial,sans-serif;
  font-size:clamp(12px,1.05vw,15px);
  line-height:1.15;
  font-weight:600;
  font-variant-numeric:tabular-nums;
  letter-spacing:-0.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
/* Valor monet√°rio */
#cards > div .text-lg.is-money{
  font-size:clamp(10px,0.75vw,12px);
  line-height:1.1;
  font-variant-numeric:tabular-nums;
  font-feature-settings:"tnum" 1, "lnum" 1;
  letter-spacing:-0.3px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:clip;
}
</style>
</head>
<body>
<header class="brand-grad text-white">
  <div class="max-w-[1500px] mx-auto px-4 py-3">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2 pr-4 mr-2 border-r border-white/20">
        <svg width="26" height="26" viewBox="0 0 24 24" class="opacity-90" aria-hidden="true"><path fill="currentColor" d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z" opacity=".3"/><path fill="currentColor" d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"/></svg>
        <div>
          <h1 class="text-base font-semibold">KPIs ‚Äî Armaz√©m | RH | Transporte</h1>
          <p class="text-[12px] opacity-90">Superfrio - Kpis Unidades</p>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label class="text-[12px]">Data in√≠cio
          <input id="dateStart" type="date" class="text-xs border rounded px-2 py-1 h-8 text-slate-800"/>
        </label>
        <label class="text-[12px]">Data fim
          <input id="dateEnd" type="date" class="text-xs border rounded px-2 py-1 h-8 text-slate-800"/>
        </label>
        <label class="btn bg-white cursor-pointer">Carregar CSV
          <input id="csvInput" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
        </label>
        <button id="btnMetas" class="btn btn-primary" type="button">Metas de KPI</button>
        <button id="btnReset" class="btn bg-white" type="button">Resetar filtros</button>
      </div>
    </div>

    <nav class="combo-nav mt-3" aria-label="Navega√ß√£o">
      <a href="#arm" id="tabArm" class="tab" aria-current="page">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 10.5V8.9l9-4.8 9 4.8v1.6l-9-4.6-9 4.6Z"/><path fill="currentColor" d="M5 11h14v8H5zM7 13h4v4H7z"/></svg>
        Armaz√©m
      </a>
      <a href="#rh" id="tabRH" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.33 0-6 1.67-6 3.75V20h12v-2.25C18 15.67 15.33 14 12 14Z"/></svg>
        RH
      </a>
      <a href="#transp" id="tabTransp" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 6h11v9H3zM14 9h4l3 3v3h-7z"/><circle cx="7" cy="18" r="2" fill="currentColor"/><circle cx="17" cy="18" r="2" fill="currentColor"/></svg>
        Transporte
      </a>
      <div id="unitsBar"></div>
    </nav>
  </div>
</header>

<main class="max-w-[1500px] mx-auto px-4 py-4">
  <details class="mb-4 bg-[var(--azul-claro)] border border-[var(--borda)] rounded-xl p-3">
    <summary class="font-medium text-[13px] text-[var(--azul)] cursor-pointer">Legenda e detalhes</summary>
    <div class="mt-2 text-[13px] text-slate-700 leading-6">
      <div class="flex flex-wrap gap-4">
        <div><span class="legend-dot dot-ok"></span>Meta atingida</div>
        <div><span class="legend-dot dot-warn"></span>Aten√ß√£o</div>
        <div><span class="legend-dot dot-bad"></span>Abaixo da meta</div>
      </div>
      <ul class="list-disc pl-5 mt-2">
        <li><strong>Sem meta</strong>: Volume In/Out, Largada total, Largada no hor√°rio, Volume.</li>
        <li><strong>Meta</strong>: % On-time (95% padr√£o), Contagem, ILA, IRA, Perdas, Ocupa√ß√£o, OT/IF/Fill Rate D-1, Turnover, Absente√≠smo.</li>
      </ul>
    </div>
  </details>

  <section id="metasBadges" class="flex flex-wrap gap-2 mb-4"></section>
  <section id="cards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-5"></section>

  <section id="secArm" class="bg-white rounded-2xl border border-[var(--borda)]">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">ARMAZ√âM</h2>
      <span id="rowsArm" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadArm"></thead><tbody id="tbodyArm"></tbody></table>
    </div>
  </section>

  <section id="secRH" class="bg-white rounded-2xl border border-[var(--borda)] hidden">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">RH</h2>
      <span id="rowsRH" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadRH"></thead><tbody id="tbodyRH"></tbody></table>
    </div>
  </section>

  <section id="secTransp" class="bg-white rounded-2xl border border-[var(--borda)] hidden">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">TRANSPORTE</h2>
      <span id="rowsTransp" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadTransp"></thead><tbody id="tbodyTransp"></tbody></table>
    </div>
  </section>
</main>

<dialog id="modalMetas" class="rounded-2xl p-0 w-[560px] max-w-[95vw]">
  <form method="dialog" class="bg-white rounded-2xl border border-[var(--borda)]">
    <div class="px-4 py-3 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h3 class="text-sm font-semibold text-[var(--azul)]">Metas de KPI</h3>
      <button id="closeMetas" class="btn" type="button">Fechar</button>
    </div>
    <div class="p-4 grid grid-cols-2 gap-3 text-xs">
      <label class="grid gap-1"><span>ON TIME D-1 (%)</span><input id="m_onTime" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IN FULL D-1 (%)</span><input id="m_inFull" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>FILL RATE D-1 (%)</span><input id="m_fillRate" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Contagem c√≠clica</span><input id="m_contagem" type="number" min="0" step="1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>ILA (%)</span><input id="m_ila" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IRA (%)</span><input id="m_ira" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Perdas (%)</span><input id="m_perdas" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Ocupa√ß√£o (%)</span><input id="m_ocupacao" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Turnover (%)</span><input id="m_turnover" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Absente√≠smo (%)</span><input id="m_abs" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
    </div>
    <div class="px-4 py-3 border-t border-[var(--borda)] flex justify-end gap-2">
      <button id="btnSalvarMetas" class="btn btn-primary" type="button">Salvar metas</button>
    </div>
  </form>
</dialog>

<!-- === DADOS EMBUTIDOS (OPCIONAL) === -->
<script id="seed-data" type="application/json">[]</script>

<script>
/* ===== CONFIG ===== */
const LS_METAS='kpiTargets_blue_v1';
const defaultTargets={onTime:95,inFull:95,fillRate:95,contagem:95,ila:95,ira:95,perdas:8,ocupacao:85,turnover:3,abs:3};
const ROUTES={arm:'arm',rh:'rh',transp:'transp'}; let activeBlock=ROUTES.arm;

const EXCEL_URL = "data/BI Operacional_Catering.xlsx"; // exatamente como est√° no repo
const EXCEL_SHEET = null; // usa a 1¬™ aba da planilha (ou coloque o nome exato da aba se preferir)


/* COLUNAS */
const HEAD_ARM=["Unidade","Data","Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem c√≠clica","ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferen√ßa de estoque)"];
const HEAD_RH=["Unidade","Data","HE armaz√©m e transporte","Turnover","Absente√≠smo","Custo MOT (armaz√©m e transporte)"];
const HEAD_TRANSP=["Unidade","Data","Largada (Total de ve√≠culos)","Largada (Ve√≠culos que sa√≠ram no horario)","% On-time (calc)","Volume (tons)","Ocupa√ß√£o","Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorr√™ncias quantidade D-1","Ocorr√™ncias em R$ D-1","Indisponibilidade de Frota (%)"];

/* TIPAGEM/FORMATO */
const pctCols=new Set([
  "ILA %","IRA %","Perdas (avarias e diferen√ßa de estoque)","Turnover","Absente√≠smo",
  "Ocupa√ß√£o","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"
]);
const intCols=new Set(["Paletes Pendentes","Horas Extras Armaz√©m","Horas Extras Transporte","Largada (Total de ve√≠culos)","Largada (Ve√≠culos que sa√≠ram no horario)","Reentrega","Ocorr√™ncias quantidade D-1"]);
const moneyCols=new Set(["Ocorr√™ncias em R$ D-1","Custo MOT (armaz√©m e transporte)"]);
const tonsCols=new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const kgCols=new Set(["Corte (KG)"]);

/* ==== UTILS ==== */
const isDash = v => typeof v === 'string' && v.trim().match(/^[-‚Äì‚Äî]+$/);
const toISODateLocal = (y,m,d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
const fmt={
  num:v=>(v??v===0)?Number(v).toLocaleString('pt-BR'):'',
  money:v=>(v??v===0)?Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}):'',
  pct:v=>(v??v===0)?`${Number(v).toFixed(1).replace('.',',')}%`:'',
  date:s=>!s?'':String(s).replace(/^(\d{4})-(\d{2})-(\d{2})$/,(a,Y,M,D)=>`${D}/${M}/${Y}`)
};
const parseDateRaw = s=>{
  if(!s) return new Date('invalid');
  const iso=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
  const dmY=String(s).match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(dmY) return new Date(+dmY[3],+dmY[2]-1,+dmY[1]);
  return new Date(s);
};
const asNumber=(v)=>{ if(v===null||v===undefined) return ''; const s=String(v).trim(); if(s===''||isDash(s)) return ''; const n=Number(s.replace(/R\$\s?/i,'').replace(/\./g,'').replace(',','.').replace(/%/g,'')); return Number.isFinite(n)?n:''; };
const asDateISO=(v)=>{ if(v==null||v===''||isDash(v)) return ''; if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v); if(!d) return ''; return toISODateLocal(d.y,d.m,d.d);} const s=String(v).trim(); const m=s.match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(m) return toISODateLocal(+m[3],+m[2]-1,+m[1]); const dt=new Date(s); return isNaN(dt)?'':toISODateLocal(dt.getFullYear(),dt.getMonth()+1,dt.getDate()); };

/* Normalizador de % */
function normPct(v){
  if(v===''||v==null) return '';
  let n=Number(String(v).replace('%','').replace(/\s/g,'').replace(',','.'));
  if(!Number.isFinite(n)) return '';
  if(n>0 && n<=1) return n*100;
  if(n<=100) return n;
  while(n>100) n/=10;
  return n;
}

/* === EMBED JSON opcional === */
function getSeedData(){
  const el=document.getElementById('seed-data');
  if(!el) return [];
  let raw=[];
  try{ raw = JSON.parse(el.textContent||'[]'); }catch(e){ return []; }
  if(!Array.isArray(raw) || !raw.length) return [];
  return raw.map(normalizeRow).filter(o=>!isRowAllBlank(o));
}
let DATA = getSeedData();

/* ELEMENTOS */
const els={dateStart:document.getElementById('dateStart'),dateEnd:document.getElementById('dateEnd'),csvInput:document.getElementById('csvInput'),btnMetas:document.getElementById('btnMetas'),modalMetas:document.getElementById('modalMetas'),closeMetas:document.getElementById('closeMetas'),btnSalvarMetas:document.getElementById('btnSalvarMetas'),btnReset:document.getElementById('btnReset'),metasBadges:document.getElementById('metasBadges'),cards:document.getElementById('cards'),unitsBar:document.getElementById('unitsBar'),tabArm:document.getElementById('tabArm'),tabRH:document.getElementById('tabRH'),tabTransp:document.getElementById('tabTransp'),secArm:document.getElementById('secArm'),secRH:document.getElementById('secRH'),secTransp:document.getElementById('secTransp'),theadArm:document.getElementById('theadArm'),tbodyArm:document.getElementById('tbodyArm'),theadRH:document.getElementById('theadRH'),tbodyRH:document.getElementById('tbodyRH'),theadTransp:document.getElementById('theadTransp'),tbodyTransp:document.getElementById('tbodyTransp'),rowsArm:document.getElementById('rowsArm'),rowsRH:document.getElementById('rowsRH'),rowsTransp:document.getElementById('rowsTransp')};
const {dateStart,dateEnd,csvInput,btnMetas,modalMetas,closeMetas,btnSalvarMetas,btnReset,metasBadges,cards,unitsBar,tabArm,tabRH,tabTransp,secArm,secRH,secTransp,theadArm,tbodyArm,theadRH,tbodyRH,theadTransp,tbodyTransp,rowsArm,rowsRH,rowsTransp}=els;

/* UNIDADES */
let UNIT_STATE=[];
function renderUnits(list){
  const units=Array.from(new Set(list.map(r=>r.Unidade))).sort();
  const prev=new Map(UNIT_STATE.map(x=>[x.u,x.on]));
  UNIT_STATE=units.map(u=>({u,on:prev.has(u)?prev.get(u):true}));
  unitsBar.innerHTML='';
  const allBtn=document.createElement('button'); allBtn.type='button'; allBtn.className='pill'; allBtn.textContent='Todas';
  allBtn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');
  allBtn.addEventListener('click',()=>{const makeOn=!UNIT_STATE.every(x=>x.on); UNIT_STATE.forEach(x=>x.on=makeOn); updateUnitPills(); refresh();});
  unitsBar.appendChild(allBtn);
  units.forEach(u=>{const b=document.createElement('button'); b.type='button'; b.className='pill'; b.textContent=u; b.dataset.u=u;
    b.setAttribute('aria-pressed', UNIT_STATE.find(x=>x.u===u)?.on?'true':'false');
    b.addEventListener('click',()=>{const item=UNIT_STATE.find(x=>x.u===u); item.on=!item.on; updateUnitPills(); refresh();});
    unitsBar.appendChild(b);
  });
}
function updateUnitPills(){unitsBar.querySelectorAll('.pill').forEach(btn=>{ if(btn.textContent==='Todas'){btn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');} else {const on=UNIT_STATE.find(x=>x.u===btn.dataset.u)?.on; btn.setAttribute('aria-pressed', on?'true':'false');}});}
function selectedUnits(){return UNIT_STATE.filter(x=>x.on).map(x=>x.u);}

/* FILTROS */
function applyFilters(data){
  let out=data.slice();
  const ds=dateStart.value?parseDateRaw(dateStart.value):null;
  const de=dateEnd.value?parseDateRaw(dateEnd.value):null;
  if(ds) out=out.filter(r=>parseDateRaw(r.Data)>=ds);
  if(de){const e=new Date(de); e.setHours(23,59,59,999); out=out.filter(r=>parseDateRaw(r.Data)<=e);}
  const units=selectedUnits();
  if(units.length && units.length!==UNIT_STATE.length) out=out.filter(r=>units.includes(r.Unidade));
  return out;
}

/* ENRIQUECIMENTO/SUM√ÅRIO */
function enrich(r){
  const vin=asNumber(r["Volume In (tons)"])||0, vout=asNumber(r["Volume Out (tons)"])||0;
  if(vin>0||vout>0) r["Volume (tons)"]= r["Volume (tons)"]!=='' ? r["Volume (tons)"] : (vin+vout);
  const hea=asNumber(r["Horas Extras Armaz√©m"]), het=asNumber(r["Horas Extras Transporte"]);
  r["HE armaz√©m e transporte"]=(hea!==''||het!=='')?((hea||0)+(het||0)):'';
  const lt=asNumber(r["Largada (Total de ve√≠culos)"])||0, ln=asNumber(r["Largada (Ve√≠culos que sa√≠ram no horario)"])||0;
  r["% On-time (calc)"]=lt>0?(ln/lt)*100:'';
  if(r["Custo MOT (armaz√©m e transporte)"]===''||r["Custo MOT (armaz√©m e transporte)"]==null) r["Custo MOT (armaz√©m e transporte)"]='';
  return r;
}
function summarize(list){
  const acc={count:list.length,sum:{},avg:{}};
  const sumCols=["Volume In (tons)","Volume Out (tons)","Volume (tons)","Corte (KG)","Paletes Pendentes","Horas Extras Armaz√©m","Horas Extras Transporte","HE armaz√©m e transporte","Largada (Total de ve√≠culos)","Largada (Ve√≠culos que sa√≠ram no horario)","Reentrega","Ocorr√™ncias quantidade D-1","Ocorr√™ncias em R$ D-1","Custo MOT (armaz√©m e transporte)"];
  const avgCols=["Contagem c√≠clica","ILA %","IRA %","Perdas (avarias e diferen√ßa de estoque)","Turnover","Absente√≠smo","Ocupa√ß√£o","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"];
  sumCols.forEach(k=>acc.sum[k]=0); avgCols.forEach(k=>acc.avg[k]=0);
  list.forEach(r=>{ sumCols.forEach(k=>acc.sum[k]+=Number(r[k])||0); avgCols.forEach(k=>{const v=Number(r[k]); if(!isNaN(v)) acc.avg[k]+=v;}); });
  avgCols.forEach(k=>{const validCount = list.filter(r => !isNaN(Number(r[k])) && r[k] !== '').length; acc.avg[k] = validCount ? acc.avg[k] / validCount : null;});
  const lt=acc.sum["Largada (Total de ve√≠culos)"], ln=acc.sum["Largada (Ve√≠culos que sa√≠ram no horario)"];
  if(lt>0) acc.avg["% On-time (calc)"]=(ln/lt)*100;
  return acc;
}

/* METAS/STATUS */
const targetMap={"Contagem c√≠clica":{k:"contagem",inverse:false},"ILA %":{k:"ila",inverse:false},"IRA %":{k:"ira",inverse:false},"Perdas (avarias e diferen√ßa de estoque)":{k:"perdas",inverse:true},"Turnover":{k:"turnover",inverse:true},"Absente√≠smo":{k:"abs",inverse:true},"Ocupa√ß√£o":{k:"ocupacao",inverse:false},"ON TIME D-1":{k:"onTime",inverse:false},"IN FULL D-1":{k:"inFull",inverse:false},"FILL RATE D-1":{k:"fillRate",inverse:false},"% On-time (calc)":{k:"onTime",inverse:false}};
const getTargets=()=>{const raw=localStorage.getItem(LS_METAS);return raw?{...defaultTargets,...JSON.parse(raw)}:{...defaultTargets}};
const saveTargets=t=>localStorage.setItem(LS_METAS,JSON.stringify(t));
function statusOf(metric,value){ const t=getTargets(); const conf=targetMap[metric]; if(!conf) return 'neutral'; const target=Number(t[conf.k]); if(isNaN(target)||value==null||value==='') return 'neutral'; if(!conf.inverse){ if(value>=target) return 'ok'; if(value>=target*0.95) return 'warn'; return 'bad'; } else { if(value<=target) return 'ok'; if(value<=target*1.10) return 'warn'; return 'bad'; } }

/* RENDER */
function renderBadges(){ const t=getTargets(); const items=[["On-time",t.onTime],["Fill Rate",t.fillRate],["In Full",t.inFull],["Contagem",t.contagem],["ILA",t.ila],["IRA",t.ira],["Perdas (m√°x)",t.perdas],["Ocupa√ß√£o",t.ocupacao],["Turnover (m√°x)",t.turnover],["Absente√≠smo (m√°x)",t.abs]]; metasBadges.innerHTML=''; items.forEach(([k,v])=>{const s=document.createElement('span'); s.className='pill'; s.textContent=`${k}: ${v}%`; metasBadges.appendChild(s);}); }
function cardHTML(label,value,type,metricKeyForStatus){
  let txt='';
  if(type==='money')      txt=fmt.money(value);
  else if(type==='pct')   txt=fmt.pct(value);
  else                    txt=fmt.num(value);
  const st=metricKeyForStatus?statusOf(metricKeyForStatus,Number(value)):'neutral';
  const valueCls = `mt-1 text-lg font-semibold text-slate-900${type==='money' ? ' is-money' : ''}`;
  return `<div class="${st} rounded-2xl border border-[var(--borda)] shadow-sm p-3">
            <div class="flex items-center gap-2 text-[12px] text-slate-600">
              <svg class="w-3.5 h-3.5 opacity-70" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2z"/></svg>
              <span>${label}</span>
            </div>
            <div class="${valueCls}">${txt||'-'}</div>
          </div>`;
}
function renderCardsFor(block,sum){
  let cardsArr=[];
  if(block===ROUTES.arm){
    cardsArr=[
      ['Volume In(t)',sum.sum["Volume In (tons)"],'num',null],
      ['Volume Out(t)',sum.sum["Volume Out (tons)"],'num',null],
      ['Corte(KG)',sum.sum["Corte (KG)"],'num',null],
      ['Contagem c√≠clica',sum.avg["Contagem c√≠clica"],'num',"Contagem c√≠clica"],
      ['ILA %',sum.avg["ILA %"],'pct',"ILA %"],
      ['IRA %',sum.avg["IRA %"],'pct',"IRA %"],
      ['Paletes Pendentes',sum.sum["Paletes Pendentes"],'num',null],
      ['Perdas (%)',sum.avg["Perdas (avarias e diferen√ßa de estoque)"],'pct',"Perdas (avarias e diferen√ßa de estoque)"]
    ];
  }else if(block===ROUTES.rh){
    cardsArr=[
      ['HE total',sum.sum["HE armaz√©m e transporte"],'num',null],
      ['Turnover %',sum.avg["Turnover"],'pct',"Turnover"],
      ['Absente√≠smo %',sum.avg["Absente√≠smo"],'pct',"Absente√≠smo"],
      ['Custo MOT (R$)',sum.sum["Custo MOT (armaz√©m e transporte)"],'money',null]
    ];
  }else{
    cardsArr=[
      ['Largada total',sum.sum["Largada (Total de ve√≠culos)"],'num',null],
      ['No hor√°rio',sum.sum["Largada (Ve√≠culos que sa√≠ram no horario)"],'num',null],
      ['% Largada',sum.avg["% On-time (calc)"],'pct',"% On-time (calc)"],
      ['Volume (t)',sum.sum["Volume (tons)"],'num',null],
      ['Ocupa√ß√£o %',sum.avg["Ocupa√ß√£o"],'pct',"Ocupa√ß√£o"],
      ['Reentrega',sum.sum["Reentrega"],'num',null],
      ['On time D-1%',sum.avg["ON TIME D-1"],'pct',"ON TIME D-1"],
      ['In full D-1%',sum.avg["IN FULL D-1"],'pct',"IN FULL D-1"],
      ['Fill rate D-1%',sum.avg["FILL RATE D-1"],'pct',"FILL RATE D-1"],
      ['Indisp. Frota %',sum.avg["Indisponibilidade de Frota (%)"],'pct',null],
      ['Ocorr√™ncias R$',sum.sum["Ocorr√™ncias em R$ D-1"],'money',null],
      ['Ocorr√™ncias',sum.sum["Ocorr√™ncias quantidade D-1"],'num',null]
    ];
  }
  cards.innerHTML=cardsArr.map(c=>cardHTML(c[0],c[1],c[2],c[3])).join('');
}
function renderHead(theadEl,HEADERS){ const tr=document.createElement('tr'); HEADERS.forEach((h,i)=>{const th=document.createElement('th'); th.className=(i===0?'col-unidade':i===1?'col-data':'col-num'); th.textContent=h; tr.appendChild(th);}); theadEl.innerHTML=''; theadEl.appendChild(tr); }
function renderBody(tbodyEl,HEADERS,list,rowsInfoEl){
  const frag=document.createDocumentFragment();
  list.forEach(r=>{
    const tr=document.createElement('tr');
    HEADERS.forEach((h)=>{
      let v=r[h];
      if(h==="Data") v=fmt.date(v);
      if(h==="Volume (tons)"&&(v==null||v==='')){ const vin=asNumber(r["Volume In (tons)"])||0; const vout=asNumber(r["Volume Out (tons)"])||0; if(vin>0||vout>0) v=vin+vout; }
      let txt=''; if(pctCols.has(h)) txt=fmt.pct(v); else if(moneyCols.has(h)) txt=fmt.money(v);
      else if(kgCols.has(h)||tonsCols.has(h)||intCols.has(h)) txt=fmt.num(v); else txt=(v??'')+'';
      const st=statusOf(h,Number(v));
      const td=document.createElement('td'); td.className=(st!=='neutral'?' '+st+' rounded-md border':''); td.textContent=txt; tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbodyEl.innerHTML=''; tbodyEl.appendChild(frag);
  if(rowsInfoEl) rowsInfoEl.textContent=list.length+" linha(s)";
}

/* NAVEGA√á√ÉO */
function getActiveFromHash(){ const h=(location.hash||'#arm').replace('#',''); if(h===ROUTES.rh) return ROUTES.rh; if(h===ROUTES.transp) return ROUTES.transp; return ROUTES.arm; }
function setActiveBlock(block){ activeBlock=block; tabArm.setAttribute('aria-current',block===ROUTES.arm?'page':'false'); tabRH.setAttribute('aria-current',block===ROUTES.rh?'page':'false'); tabTransp.setAttribute('aria-current',block!==ROUTES.transp?'false':'page'); secArm.classList.toggle('hidden',block!==ROUTES.arm); secRH.classList.toggle('hidden',block!==ROUTES.rh); secTransp.classList.toggle('hidden',block!==ROUTES.transp); refresh(); }
window.addEventListener('hashchange',()=>setActiveBlock(getActiveFromHash()));

const PCT = new Set(["ILA %","IRA %","Perdas (avarias e diferen√ßa de estoque)","Turnover","Absente√≠smo","Ocupa√ß√£o","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
const MONEY = new Set(["Ocorr√™ncias em R$ D-1","Custo MOT (armaz√©m e transporte)"]);
const INTLIKE = new Set(["Paletes Pendentes","Largada (Total de ve√≠culos)","Largada (Ve√≠culos que sa√≠ram no horario)","Reentrega","Ocorr√™ncias quantidade D-1","Horas Extras Armaz√©m","Horas Extras Transporte"]);
const TONS = new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const KEY_NUMERIC = new Set(["Volume In (tons)","Volume Out (tons)","Corte (KG)","Paletes Pendentes","Largada (Total de ve√≠culos)","Largada (Ve√≠culos que sa√≠ram no horario)","Reentrega","Ocorr√™ncias quantidade D-1","Ocorr√™ncias em R$ D-1","Contagem c√≠clica","ILA %","IRA %","Perdas (avarias e diferen√ßa de estoque)","Turnover","Absente√≠smo","Ocupa√ß√£o","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Indisponibilidade de Frota (%)","Volume (tons)"]);

const normalizeRow=(row)=>{
  const o={};
  for(const k in row){ const key=String(k).trim(); const val=isDash(row[k])?'':row[k]; o[key]=val; }
  if(o["Indisponibilidade de Frota"]!==undefined && o["Indisponibilidade de Frota (%)"]===undefined) o["Indisponibilidade de Frota (%)"]=o["Indisponibilidade de Frota"];
  o["Data"]=asDateISO(o["Data"]);

  Object.keys(o).forEach(k=>{
    if(PCT.has(k)) { o[k]=normPct(o[k]); return; }
    if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
    if(k==="Contagem c√≠clica"){ const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
  });

  if(o["Volume (tons)"]===''||o["Volume (tons)"]==null){
    const vin=asNumber(o["Volume In (tons)"])||0, vout=asNumber(o["Volume Out (tons)"])||0;
    o["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):'';
  }
  return o;
};
const isRowAllBlank=(o)=>{
  if(!o["Unidade"]||!o["Data"]) return true;
  for(const k of KEY_NUMERIC){ const v=o[k]; if(v!=='' && Number(v)!==0) return false; }
  return true;
};

/* CSV (fallback manual) */
function parseCSV(text){
  const delimiter=text.indexOf(';')>-1?';':',';
  const lines=text.trim().split(/\r?\n/);
  const headers=lines[0].split(delimiter).map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols=[]; let cur='',inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){inQ=!inQ;continue;} if(!inQ&&ch===delimiter){cols.push(cur);cur='';continue;} cur+=ch; }
    cols.push(cur);
    const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]!==undefined?cols[i].trim():'');
    Object.keys(obj).forEach(k=>{ if(isDash(obj[k])) obj[k]=''; });
    if(obj["Data"] && /^\d{2}[./]\d{2}[./]\d{4}$/.test(obj["Data"])){ const [d,m,y]=obj["Data"].replace(/\./g,'/').split('/').map(Number); obj["Data"]=toISODateLocal(y,m,d); }
    Object.keys(obj).forEach(k=>{
      if(PCT.has(k)) { obj[k]=normPct(obj[k]); return; }
      if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; }
      if(k==="Contagem c√≠clica"){ const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; }
    });
    if(obj["Volume (tons)"]===undefined||obj["Volume (tons)"]===''){ const vin=asNumber(obj["Volume In (tons)"])||0, vout=asNumber(obj["Volume Out (tons)"])||0; obj["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):''; }
    return obj;
  });
}

/* METAS UI */
function openMetas(){const t=getTargets(); m_onTime.value=t.onTime; m_inFull.value=t.inFull; m_fillRate.value=t.fillRate; m_contagem.value=t.contagem; m_ila.value=t.ila; m_ira.value=t.ira; m_perdas.value=t.perdas; m_ocupacao.value=t.ocupacao; m_turnover.value=t.turnover; m_abs.value=t.abs; modalMetas.showModal();}
function saveMetas(){ const t={onTime:+(m_onTime.value||defaultTargets.onTime),inFull:+(m_inFull.value||defaultTargets.inFull),fillRate:+(m_fillRate.value||defaultTargets.fillRate),contagem:+(m_contagem.value||defaultTargets.contagem),ila:+(m_ila.value||defaultTargets.ila),ira:+(m_ira.value||defaultTargets.ira),perdas:+(m_perdas.value||defaultTargets.perdas),ocupacao:+(m_ocupacao.value||defaultTargets.ocupacao),turnover:+(m_turnover.value||defaultTargets.turnover),abs:+(m_abs.value||defaultTargets.abs)}; saveTargets(t); renderBadges(); refresh(); modalMetas.close(); }

/* Filtro por bloco */
const hasAnyForHeaders=(row,HEADERS)=> HEADERS.slice(2).some(h=>{ const v=row[h]; if(v===''||v==null) return false; const n=Number(v); return Number.isFinite(n)?n!==0:String(v).trim()!==''; });

/* HEADERS/TABELAS */
function renderHeadsOnce(){ if(!theadArm.hasChildNodes()) renderHead(theadArm,HEAD_ARM); if(!theadRH.hasChildNodes()) renderHead(theadRH,HEAD_RH); if(!theadTransp.hasChildNodes()) renderHead(theadTransp,HEAD_TRANSP); }
function refresh(){
  const enriched=DATA.map(r=>enrich({...r}));
  const filtered=applyFilters(enriched);
  const HEADERS=activeBlock===ROUTES.arm?HEAD_ARM:(activeBlock===ROUTES.rh?HEAD_RH:HEAD_TRANSP);
  const filteredForBlock=filtered.filter(r=>hasAnyForHeaders(r,HEADERS));
  const sum=summarize(filteredForBlock);
  renderBadges(); renderHeadsOnce(); renderCardsFor(activeBlock,sum);
  if(activeBlock===ROUTES.arm) renderBody(tbodyArm,HEAD_ARM,filteredForBlock,rowsArm);
  else if(activeBlock===ROUTES.rh) renderBody(tbodyRH,HEAD_RH,filteredForBlock,rowsRH);
  else renderBody(tbodyTransp,HEAD_TRANSP,filteredForBlock,rowsTransp);
}

/* === NOVO: carregar Excel do reposit√≥rio no boot === */
async function loadExcelFromRepo(){
  try{
    const res = await fetch(EXCEL_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`N√£o encontrei ${EXCEL_URL} (HTTP ${res.status})`);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error(`Aba n√£o encontrada: ${EXCEL_SHEET||'(primeira aba)'}`);

    // Recorte igual ao seu upload: cabe√ßalho na linha 3 e come√ßa na coluna B
    const ref = XLSX.utils.decode_range(ws['!ref']);
    ref.s.r = Math.max(ref.s.r, 2);  // linha 3 (0-based)
    ref.s.c = Math.max(ref.s.c, 1);  // coluna B (0-based)
    const newRef = XLSX.utils.encode_range(ref);

    let rows = XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows = rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    if(!rows.length) throw new Error("Planilha vazia ap√≥s normaliza√ß√£o.");
    DATA = rows;
    console.log('CARREGADO_DO_REPO:', {linhas: DATA.length, aba: (EXCEL_SHEET||wb.SheetNames[0])});
  }catch(err){
    console.warn("Falha ao carregar Excel do reposit√≥rio:", err);
    // Mant√©m DATA como est√° (pode vir do seed-data) e o usu√°rio ainda pode usar o bot√£o de upload manual se quiser
  }
}

/* Inicializa√ß√£o UI (datas, abas, unidades) */
function bootstrap(){
  const hasData = Array.isArray(DATA) && DATA.length>0;
  const afterDataReady = ()=>{
    renderUnits(DATA);
    const minD=new Date(Math.min(...DATA.map(r=>+parseDateRaw(r.Data))));
    const maxD=new Date(Math.max(...DATA.map(r=>+parseDateRaw(r.Data))));
    if(!isNaN(minD)) dateStart.value=toISODateLocal(minD.getFullYear(),minD.getMonth()+1,minD.getDate());
    if(!isNaN(maxD)) dateEnd.value=toISODateLocal(maxD.getFullYear(),maxD.getMonth()+1,maxD.getDate());
    setActiveBlock(getActiveFromHash()); if(!location.hash) history.replaceState(null,'','#'+activeBlock);
  };

  if(hasData){
    afterDataReady();
  }else{
    // tenta Excel est√°tico do reposit√≥rio
    loadExcelFromRepo().then(afterDataReady);
  }
}

/* EVENTOS */
dateStart.addEventListener('change',refresh);
dateEnd.addEventListener('change',refresh);
btnReset.addEventListener('click',()=>{ dateStart.value=''; dateEnd.value=''; UNIT_STATE.forEach(x=>x.on=true); updateUnitPills(); refresh(); });
btnMetas.addEventListener('click',openMetas);
closeMetas.addEventListener('click',e=>{e.preventDefault();modalMetas.close();});
btnSalvarMetas.addEventListener('click',e=>{e.preventDefault();saveMetas();});
modalMetas.addEventListener('cancel',()=>modalMetas.close());

/* IMPORTA√á√ÉO MANUAL (fallback opcional) */
csvInput.addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  if(/\.(xlsx|xls)$/i.test(f.name)){
    const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets['Base']||wb.Sheets[wb.SheetNames[0]];
    const ref=XLSX.utils.decode_range(ws['!ref']); ref.s.r=Math.max(ref.s.r,2); ref.s.c=Math.max(ref.s.c,1); const newRef=XLSX.utils.encode_range(ref);
    let rows=XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows=rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    DATA=rows; console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
  }else{
    DATA=parseCSV(await f.text()).map(normalizeRow).filter(o=>!isRowAllBlank(o));
    console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
    if(!DATA.length) return alert('Arquivo vazio ou inv√°lido.');
  }
  renderUnits(DATA); updateUnitPills();
  const minD=new Date(Math.min(...DATA.map(r=>+parseDateRaw(r.Data)))); const maxD=new Date(Math.max(...DATA.map(r=>+parseDateRaw(r.Data))));
  if(!isNaN(minD)) dateStart.value=toISODateLocal(minD.getFullYear(),minD.getMonth()+1,minD.getDate());
  if(!isNaN(maxD)) dateEnd.value=toISODateLocal(maxD.getFullYear(),maxD.getMonth()+1,maxD.getDate());
  refresh();
});

/* START */
bootstrap();

/* Ajuste responsivo dos cards */
(function(){
  const cont=document.getElementById('cards'); if(!cont) return;
  let rafId=null;
  function fit(){ const items=[...cont.children]; if(!items.length) return; const gap=12,total=items.length,w=cont.clientWidth||cont.offsetWidth; let cw=Math.floor((w-gap*(total-1))/total); cw=Math.max(96,Math.min(210,cw)); cont.style.setProperty('--cardW',cw+'px'); items.forEach(el=>el.style.width=cw+'px'); }
  const mo=new MutationObserver(()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  mo.observe(cont,{childList:true});
  const ro=new ResizeObserver(()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  ro.observe(cont);
  window.addEventListener('resize',()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  requestAnimationFrame(fit);
})();
</script>
<!-- === INSIGHT ENGINE (colar antes de </body>) === -->
<style>
  .insights-fab{position:fixed;right:18px;bottom:18px;z-index:9999;padding:.9rem 1.1rem;border-radius:999px;border:1px solid #cfe0ff;background:#0b3a8a;color:#fff;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,.18);cursor:pointer}
  .insights-panel{position:fixed;right:18px;bottom:86px;z-index:9999;width:min(720px,92vw);max-height:75vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 20px 40px rgba(2,6,23,.18)}
  .insights-panel header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef2ff;background:linear-gradient(90deg,#0b3a8a,#1673ff);color:#fff;border-top-left-radius:16px;border-top-right-radius:16px}
  .insights-panel section{padding:14px 16px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:.18rem .5rem;border-radius:999px;border:1px solid #e5e7eb;font-size:12px;background:#f8fafc;color:#0f172a}
  .ok{color:#065f46} .warn{color:#92400e} .bad{color:#991b1b}
  .list{margin:8px 0 0 0;padding-left:16px}
  .list li{margin:4px 0}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-bottom-width:2px;padding:.05rem .35rem;border-radius:6px}
</style>

<button class="insights-fab" id="btnInsights">Analisar KPIs</button>
<div class="insights-panel" id="panelInsights" style="display:none">
  <header>
    <strong>Insights autom√°ticos ‚Äî KPIs</strong>
    <button id="closeInsights" class="chip" title="Fechar">Fechar ‚úï</button>
  </header>
  <section id="insightsContent">
    <div class="chip">Lendo KPIs da tela‚Ä¶</div>
  </section>
</div>

<script>
(()=>{
const THRESH = {
  ONTIME_OK:95, ONTIME_CRIT:90,
  INFULL_OK:95, INFULL_CRIT:90,
  FILL_OK:98, FILL_CRIT:95,
  ILA_OK:100, IRA_OK:100,
  PERDAS_WARN:0.3, PERDAS_CRIT:1.0,
  OCUP_OK_MIN:85, OCUP_OK_MAX:95,
  TURNOVER_WARN:5, TURNOVER_CRIT:10,
  ABSENT_WARN:3, ABSENT_CRIT:5
};

const pct = v => (v!=null && !Number.isNaN(v)) ? `${v.toFixed(2)}%` : "‚Äî";
function toNum(s){
  if(!s) return NaN;
  const m = String(s).replace(/\s/g,'').match(/-?\d+(?:[\.,]\d+)?/);
  if(!m) return NaN;
  return parseFloat(m[0].replace('.','').replace(',','.'));
}
function findClosestPercentage(el){
  const text = (el.innerText||"") + " " + ([...el.querySelectorAll('*')].map(e=>e.innerText).join(' ')||"");
  let m = text.match(/-?\d{1,3}(?:[\.,]\d+)?\s*%/);
  if(m) return toNum(m[0]);
  m = text.match(/-?\d{1,3}(?:[\.,]\d+)?/);
  if(m) return toNum(m[0]);
  return NaN;
}

const LABELS = [
  {key:'onTime', re:/(on[\s-]?time|ontime)/i},
  {key:'inFull', re:/(in\s*full|infull|if\b)/i},
  {key:'fillRate', re:/(fill\s*rate|fillrate|fr\b)/i},
  {key:'ila', re:/\bila\b/i},
  {key:'ira', re:/\bira\b/i},
  {key:'perdas', re:/(perdas|avarias|diferen[√ßc]a\s*de\s*estoque)/i},
  {key:'ocupacao', re:/(ocupa[c√ß][a√£]o|ocupacao)/i},
  {key:'turnover', re:/turnover/i},
  {key:'absenteismo', re:/(absent(e[i]s)?[i√≠]smo|absenteismo)/i},
];

function collectKPIsFromDataAttrs(){
  const out = {};
  document.querySelectorAll('[data-kpi]').forEach(el=>{
    const key = String(el.getAttribute('data-kpi')||'').trim();
    let v = el.getAttribute('data-value');
    v = v!=null ? toNum(v) : findClosestPercentage(el);
    if(!Number.isNaN(v)) out[key]=v;
  });
  return out;
}
function collectKPIsFromLabels(){
  const out = {};
  const all = [...document.querySelectorAll('body *')]
    .filter(el=>el.children.length===0 && (el.innerText||'').trim().length>0);
  LABELS.forEach(({key,re})=>{
    let best = null, bestDist = Infinity;
    all.forEach(el=>{
      if(re.test(el.innerText)){
        const v = findClosestPercentage(el);
        if(!Number.isNaN(v)){
          const d = 0;
          if(d<bestDist){best={el,v};bestDist=d;}
        }else{
          const sibs = [...(el.parentElement?.children||[])];
          for(const s of sibs){
            const vv = findClosestPercentage(s);
            if(!Number.isNaN(vv)){
              const d = 1;
              if(d<bestDist){best={el:s,v:vv};bestDist=d;}
            }
          }
        }
      }
    });
    if(best && !Number.isNaN(best.v)) out[key]=best.v;
  });
  return out;
}

function mergePriority(a,b){ return {...a, ...b}; }
function getKPIs(){
  const byAttrs  = collectKPIsFromDataAttrs();
  const byLabels = collectKPIsFromLabels();
  return mergePriority(byLabels, byAttrs);
}

function analyze(k){
  const good=[], warn=[], bad=[], suggest=[];
  const push = (arr,msg)=>arr.push(msg);

  const o = k.onTime; if(!Number.isNaN(o)){
    if(o>=THRESH.ONTIME_OK) push(good, `On-time ${pct(o)} dentro/above da meta (‚â• ${THRESH.ONTIME_OK}%).`);
    else if(o>=THRESH.ONTIME_CRIT) { push(warn, `On-time ${pct(o)} abaixo da meta. Meta: ${THRESH.ONTIME_OK}%.`); suggest.push(`Revisar causas de atraso (janela de corte, carga/descarga, rotas).`); }
    else { push(bad, `On-time cr√≠tico em ${pct(o)} (< ${THRESH.ONTIME_CRIT}%).`); suggest.push(`Plano de a√ß√£o imediato para atrasos recorrentes e gargalos.`); }
  }
  const inf = k.inFull; if(!Number.isNaN(inf)){
    if(inf>=THRESH.INFULL_OK) push(good, `In-Full ${pct(inf)} saud√°vel (‚â• ${THRESH.INFULL_OK}%).`);
    else if(inf>=THRESH.INFULL_CRIT){ push(warn, `In-Full ${pct(inf)} pede aten√ß√£o.`); suggest.push(`Checar rupturas/picking incompleto e acur√°cia de estoque.`); }
    else { push(bad, `In-Full cr√≠tico em ${pct(inf)}.`); suggest.push(`A√ß√£o em causas-raiz: planejamento, estoque de seguran√ßa, SLA fornecedores.`); }
  }
  const fr = k.fillRate; if(!Number.isNaN(fr)){
    if(fr>=THRESH.FILL_OK) push(good, `Fill Rate ${pct(fr)} excelente (‚â• ${THRESH.FILL_OK}%).`);
    else if(fr>=THRESH.FILL_CRIT){ push(warn, `Fill Rate ${pct(fr)} abaixo do ideal.`); suggest.push(`Ajustar pol√≠ticas de reposi√ß√£o e prioriza√ß√£o de pedidos.`); }
    else { push(bad, `Fill Rate ${pct(fr)} muito baixo.`); suggest.push(`Rever forecast e alinhamento comercial/log√≠stica.`); }
  }
  const ila = k.ila; if(!Number.isNaN(ila)){
    if(ila>=THRESH.ILA_OK) push(good, `ILA ${pct(ila)} ok (alvo 100%).`);
    else { push(warn, `ILA ${pct(ila)} abaixo de 100%.`); suggest.push(`Corrigir lan√ßamentos/processos que afetam disponibilidade.`); }
  }
  const ira = k.ira; if(!Number.isNaN(ira)){
    if(ira>=THRESH.IRA_OK) push(good, `IRA ${pct(ira)} ok (alvo 100%).`);
    else { push(warn, `IRA ${pct(ira)} abaixo de 100%.`); suggest.push(`Atuar em recebimento, confer√™ncia e integridade dos itens.`); }
  }
  const perdas = k.perdas; if(!Number.isNaN(perdas)){
    if(perdas<=THRESH.PERDAS_WARN) push(good, `Perdas ${pct(perdas)} controladas (‚â§ ${THRESH.PERDAS_WARN}%).`);
    else if(perdas<=THRESH.PERDAS_CRIT) { push(warn, `Perdas ${pct(perdas)} elevadas.`); suggest.push(`Foco em causas (avarias, validade, diferen√ßa de estoque).`); }
    else { push(bad, `Perdas ${pct(perdas)} cr√≠ticas.`); suggest.push(`A√ß√£o corretiva urgente (embalagem, manuseio, invent√°rio).`); }
  }
  const oc = k.ocupacao; if(!Number.isNaN(oc)){
    if(oc>=THRESH.OCUP_OK_MIN && oc<=THRESH.OCUP_OK_MAX) push(good, `Ocupa√ß√£o ${pct(oc)} saud√°vel (${THRESH.OCUP_OK_MIN}‚Äì${THRESH.OCUP_OK_MAX}%).`);
    else if(oc>THRESH.OCUP_OK_MAX){ push(warn, `Ocupa√ß√£o ${pct(oc)} alta (risco de overflow).`); suggest.push(`Planejar ressuprimento/sa√≠das e realoca√ß√£o de posi√ß√µes.`); }
    else { push(warn, `Ocupa√ß√£o ${pct(oc)} baixa (subutiliza√ß√£o).`); suggest.push(`Ajustar mix/entrada de clientes e uso de √°rea.`); }
  }
  const t = k.turnover; if(!Number.isNaN(t)){
    if(t<=THRESH.TURNOVER_WARN) push(good, `Turnover ${pct(t)} sob controle (‚â§ ${THRESH.TURNOVER_WARN}%).`);
    else if(t<=THRESH.TURNOVER_CRIT){ push(warn, `Turnover ${pct(t)} pede aten√ß√£o.`); suggest.push(`Reter talentos cr√≠ticos e refor√ßar treinamento.`); }
    else { push(bad, `Turnover ${pct(t)} muito alto.`); suggest.push(`Plano de reten√ß√£o e revis√£o de escalas/benef√≠cios.`); }
  }
  const ab = k.absenteismo; if(!Number.isNaN(ab)){
    if(ab<=THRESH.ABSENT_WARN) push(good, `Absente√≠smo ${pct(ab)} ok (‚â§ ${THRESH.ABSENT_WARN}%).`);
    else if(ab<=THRESH.ABSENT_CRIT){ push(warn, `Absente√≠smo ${pct(ab)} elevado.`); suggest.push(`Acompanhar faltas reincidentes e cobertura de turnos.`); }
    else { push(bad, `Absente√≠smo ${pct(ab)} cr√≠tico.`); suggest.push(`A√ß√£o imediata em clima, transporte e sa√∫de ocupacional.`); }
  }

  return {good, warn, bad, suggest};
}

function renderInsights(res){
  const root = document.getElementById('insightsContent');
  const sect = (title, cls, arr)=> arr.length? `
    <h3 class="${cls}" style="margin:.4rem 0 .2rem 0;font-weight:700">${title}</h3>
    <ul class="list">${arr.map(x=>`<li>${x}</li>`).join('')}</ul>
  ` : '';
  root.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:.5rem">
      <span class="chip">Leituras autom√°ticas da tela</span>
      <span class="chip">Sem envio de dados</span>
      <span class="chip">Ajuste os limiares no script</span>
    </div>
    ${sect('‚úîÔ∏é O que est√° bom', 'ok', res.good)}
    ${sect('‚ö†Ô∏é Pontos de aten√ß√£o', 'warn', res.warn)}
    ${sect('‚õî Riscos / cr√≠ticos', 'bad', res.bad)}
    ${sect('üí° Sugest√µes', '', res.suggest)}
    <div style="margin-top:.8rem;font-size:12px;color:#475569">
      Dica: para leituras 100% precisas, adicione <span class="kbd">data-kpi</span> e <span class="kbd">data-value</span> nos cards (ex.: <span class="kbd">&lt;div data-kpi="onTime" data-value="94.2"&gt;</span>).
    </div>
  `;
}

const btn = document.getElementById('btnInsights');
const panel = document.getElementById('panelInsights');
const closeBtn = document.getElementById('closeInsights');

async function runAnalysis(){
  const kpis = getKPIs();
  const res = analyze(kpis);
  renderInsights(res);
}

btn.addEventListener('click', ()=>{
  panel.style.display = panel.style.display==='none' ? 'block' : 'none';
  if(panel.style.display==='block') runAnalysis();
});
closeBtn.addEventListener('click', ()=> panel.style.display='none');

document.addEventListener('keydown', (e)=>{
  if(e.altKey && (e.key==='i' || e.key==='I')) {
    btn.click();
  }
});
})();
</script>
<!-- === /INSIGHT ENGINE === -->
</body>
</html>
