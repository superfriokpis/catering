<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard - Kpis</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* ==========================================================================
   Design System & Premium Enhancements
   ========================================================================== */
:root {
  --brand-primary: #1d4ed8;
  --brand-primary-dark: #1e40af;
  --brand-primary-light: #eff5ff;
  --brand-gradient-start: #2563eb;
  --brand-gradient-end: #3b82f6;

  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-subtle: #64748b;

  --surface-default: #ffffff;
  --surface-subtle: #f8fafc;

  --border-default: #e2e8f0;
  --border-strong: #cbd5e1;

  --status-ok-border: #10b981;
  --status-warn-border: #f97316;
  --status-bad-border: #f43f5e;

  --status-ok-fg: #047857;
  --status-warn-fg: #c2410c;
  --status-bad-fg: #be123c;

  --status-ok-bg: rgba(16, 185, 129, 0.08);
  --status-warn-bg: rgba(249, 115, 22, 0.08);
  --status-bad-bg: rgba(244, 63, 94, 0.08);

  --status-neutral-bg: #f8fafc; 
  --status-neutral-fg: #475569; 
  --status-neutral-border: #94a3b8;

  --border-radius-sm: .5rem;
  --border-radius-md: .75rem;
  --border-radius-lg: 1rem;

  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

  --safe-bottom: calc(18px + env(safe-area-inset-bottom, 0px));
}

html, body {
  background-color: var(--surface-subtle);
  color: var(--text-primary);
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Header */
.brand-grad { background: linear-gradient(90deg, var(--brand-primary-dark), var(--brand-primary)); }
.app-header { position: sticky; top: 0; z-index: 40; backdrop-filter: saturate(1.05); box-shadow: var(--shadow-sm); }
.app-header.is-stuck { box-shadow: 0 8px 24px rgb(2 6 23 / .15); }

/* Pills & Buttons */
.tab, .pill {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 13px; font-weight: 500; padding: .5rem 1rem;
  border-radius: 999px; border: 1px solid var(--border-default);
  background: var(--surface-default); color: var(--brand-primary);
  transition: all .2s ease-in-out; white-space: nowrap; text-decoration: none; cursor: pointer;
}
.tab:hover, .pill:hover { background: var(--brand-primary-light); border-color: #a5b4fc; }
.tab:focus-visible, .pill:focus-visible, .btn:focus-visible, .minimal-input:focus-visible {
  outline: none; box-shadow: 0 0 0 3px var(--brand-primary-light), 0 0 0 1.5px var(--brand-primary);
}
.tab[aria-current="page"], .pill[aria-pressed="true"] {
  background: linear-gradient(135deg, var(--brand-gradient-start), var(--brand-gradient-end));
  color: #fff; border-color: transparent; box-shadow: 0 4px 14px rgba(37, 99, 235, .25);
}
.tab svg { width: 16px; height: 16px; }
.tab[aria-current="page"] svg { filter: drop-shadow(0 1px 1px rgba(0,0,0,.2)); }

.btn {
  font-size: 13px; font-weight: 500;
  border: 1px solid var(--border-default);
  background: var(--surface-default); color: var(--brand-primary);
  padding: .5rem 1rem; border-radius: var(--border-radius-sm); transition: all .2s;
}
.btn:hover { background-color: var(--surface-subtle); }
.btn-primary { background: var(--brand-primary); color: #fff; border-color: var(--brand-primary); }
.btn-primary:hover { background: var(--brand-primary-dark); }

/* Cards */
#cards { display: grid !important; gap: 12px; }
.kpi-card {
  display: flex; flex-direction: column; justify-content: space-between;
  border-radius: var(--border-radius-lg); padding: .75rem 1rem; border-top: 4px solid transparent;
  background-color: var(--surface-default); box-shadow: var(--shadow-sm); border: 1px solid var(--border-default);
  transition: transform .2s ease-out, box-shadow .2s ease-out;
}
.kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
.kpi-card .card-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.kpi-card .card-value { font-size: clamp(16px, 1.5vw, 20px); font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-variant-numeric: tabular-nums; }
.kpi-card .card-value.is-money { font-size: clamp(14px, 1.2vw, 18px); }
.ok .card-value{ color: var(--status-ok-border);} .warn .card-value{ color: var(--status-warn-border);} .bad .card-value{ color: var(--status-bad-border);}
.ok{ border-top-color: var(--status-ok-border);} .warn{ border-top-color: var(--status-warn-border);} .bad{ border-top-color: var(--status-bad-border);} .neutral{ border-top-color: var(--status-neutral-border);}

/* Sections & Tables */
.data-section { background-color: var(--surface-default); border-radius: var(--border-radius-lg); border: 1px solid var(--border-default); box-shadow: var(--shadow-sm); overflow: hidden; }
.data-section-header { padding: .75rem 1rem; border-bottom: 1px solid var(--border-default); background-color: var(--surface-subtle); display: flex; align-items: center; justify-content: space-between; }
.data-section-title { font-size: 13px; font-weight: 700; color: var(--brand-primary); text-transform: uppercase; letter-spacing: 0.5px; }
.data-section-content { padding: .5rem; }

table.kpi { width: 100%; border-collapse: collapse; }
table.kpi th, table.kpi td { padding: .6rem .5rem; font-size: 12px; text-align: center; vertical-align: middle; white-space: nowrap; }
table.kpi thead th { position: sticky; top: 0; z-index: 1; background: var(--brand-primary-dark); color: #fff; font-weight: 700; box-shadow: 0 1px 0 var(--border-default); }
table.kpi tbody tr { border-bottom: 1px solid var(--border-default); }
table.kpi tbody tr:last-child { border-bottom: none; }
table.kpi tbody tr:hover { background-color: var(--brand-primary-light); }

.col-unidade{min-width:100px}
.col-data{min-width:110px}
.col-num{min-width:80px}

/* RH & Transp responsive font size */
#secRH table.kpi th, #secRH table.kpi td,
#secTransp table.kpi th, #secTransp table.kpi td { font-size: clamp(10px, .9vw, 12px); }

/* Legend */
.legend-dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; margin-right: .35rem; }
.dot-ok{background: var(--status-ok-border);} .dot-warn{background: var(--status-warn-border);} .dot-bad{background: var(--status-bad-border);}

/* ====== (NOVO) Quebra de linha no cabeçalho ====== */
table.kpi thead th{
  white-space: normal !important;
  line-height: 1.15;
  text-wrap: balance;
  word-break: keep-all;
}
table.kpi tbody td{ white-space: nowrap; }
table.kpi thead th small{
  display:block; font-size:11px; font-weight:600; opacity:.9;
}

/* Farol */
.fab{
  position:fixed;right:18px;bottom:var(--safe-bottom);z-index:9999;
  padding:.9rem 1.1rem;border-radius:999px;border:0;background:var(--brand-primary);
  color:#fff;font-weight:600;box-shadow:var(--shadow-lg);cursor:pointer; transition: transform .2s ease-out;
}
.fab:hover { transform: scale(1.05); }
.fab:focus-visible { outline:none; box-shadow:0 0 0 3px var(--brand-primary-light), 0 0 0 1.5px var(--brand-primary); }
#modalFarol::backdrop{background:rgba(2,6,23,.5); backdrop-filter: blur(4px); }
#modalFarol .hdr{background:linear-gradient(90deg,var(--brand-primary-dark), var(--brand-primary));color:#fff}
.faro-legend .chip{display:inline-flex;align-items:center;gap:8px;font-size:12px;padding:.2rem .6rem;border-radius:999px;background:#f8fafc;border:1px solid var(--border-default)}
.dot{display:inline-block;width:12px;height:12px;border-radius:999px}
.dot.g{background: var(--status-ok-border);} .dot.y{background: var(--status-warn-border);} .dot.r{background: var(--status-bad-border);}
.tbl-farol{width:100%;border-collapse:separate;border-spacing:0}
.tbl-farol th{font-size:12px;background:var(--brand-primary);color:#fff;text-align:left;padding:10px;border-top-left-radius:var(--border-radius-sm);border-top-right-radius:var(--border-radius-sm)}
.tbl-farol td{padding:12px 10px;border-bottom:1px solid #eff2f7}
.tbl-farol tr:hover td{background:var(--brand-primary-light)}
.cell-dot{display:flex;align-items:center;gap:8px}
.minimal-input{border:1px solid var(--border-default);border-radius:var(--border-radius-md);padding:8px 12px;font-size:13px;width:320px; transition: all .2s;}
.minimal-input:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px var(--brand-primary-light); outline:none; }

/* Aux */
main { padding-bottom: 120px; }
@media (max-width: 640px){ main { padding-bottom: 160px; } }
a, button, input, summary { outline-offset: 2px; }
@media (prefers-reduced-motion: reduce){ .kpi-card, .fab { transition: none !important; } }

/* Print */
@media print {
  header, nav, .fab, .insights-fab, #panelInsights, #modalMetas, #metasBadges, #cards, main > details { display: none !important; }
  #modalFarol, #modalFarol * { display: block !important; position: static !important; inset: auto !important; }
  .tbl-farol { font-size: 12px; }
}
</style>
</head>

<body class="bg-slate-50">
<header class="brand-grad text-white shadow-md app-header" id="appHeader">
  <div class="max-w-[1500px] mx-auto px-4 py-3">
    <div class="flex flex-wrap items-center gap-x-4 gap-y-3">
      <div class="flex items-center gap-3 pr-4 mr-2 border-r border-white/20">
        <svg width="28" height="28" viewBox="0 0 24 24" class="opacity-90" aria-hidden="true"><path fill="currentColor" d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z" opacity=".3"/><path fill="currentColor" d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"/></svg>
        <div>
          <h1 class="text-lg font-bold tracking-tight">KPIs — Armazém | RH | Transporte</h1>
          <p class="text-[12px] opacity-80">Superfrio - Kpis Unidades</p>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label class="text-[12px]">Data início
          <input id="dateStart" type="date" class="text-sm border rounded-md px-2 py-1 h-9 text-slate-800"/>
        </label>
        <label class="text-[12px]">Data fim
          <input id="dateEnd" type="date" class="text-sm border rounded-md px-2 py-1 h-9 text-slate-800"/>
        </label>
        <label class="btn bg-white cursor-pointer">Carregar CSV
          <input id="csvInput" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
        </label>
        <button id="btnMetas" class="btn btn-primary" type="button">Metas de KPI</button>
        <button id="btnReset" class="btn bg-white" type="button">Resetar filtros</button>
      </div>
    </div>

    <nav class="flex items-center gap-2 mt-4 overflow-x-auto pb-1" aria-label="Navegação">
      <a href="#arm" id="tabArm" class="tab" aria-current="page">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 10.5V8.9l9-4.8 9 4.8v1.6l-9-4.6-9 4.6Z"/><path fill="currentColor" d="M5 11h14v8H5zM7 13h4v4H7z"/></svg>
        Armazém
      </a>
      <a href="#rh" id="tabRH" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.33 0-6 1.67-6 3.75V20h12v-2.25C18 15.67 15.33 14 12 14Z"/></svg>
        RH
      </a>
      <a href="#transp" id="tabTransp" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 6h11v9H3zM14 9h4l3 3v3h-7z"/><circle cx="7" cy="18" r="2" fill="currentColor"/><circle cx="17" cy="18" r="2" fill="currentColor"/></svg>
        Transporte
      </a>
      <div id="unitsBar" class="flex gap-2 ml-4 border-l border-white/20 pl-4"></div>
    </nav>
  </div>
</header>

<main class="max-w-[1500px] mx-auto px-4 py-5">
  <details class="mb-4 bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
    <summary class="font-medium text-sm text-[var(--brand-primary)] cursor-pointer">Legenda e detalhes</summary>
    <div class="mt-3 text-sm text-slate-700 leading-6">
      <div class="flex flex-wrap gap-4">
        <div><span class="legend-dot dot-ok"></span>Meta atingida</div>
        <div><span class="legend-dot dot-warn"></span>Atenção</div>
        <div><span class="legend-dot dot-bad"></span>Abaixo da meta</div>
      </div>
      <ul class="list-disc pl-5 mt-2 text-xs">
        <li><strong>Sem meta</strong>: Volume In/Out, Largada total, Largada no horário, Volume.</li>
        <li><strong>Meta</strong>: % On-time (95% padrão), Contagem, ILA, IRA, Perdas, Ocupação, OT/IF/Fill Rate D-1, Turnover, Absenteísmo.</li>
      </ul>
    </div>
  </details>

  <section id="metasBadges" class="flex flex-wrap gap-2 mb-4"></section>
  <section id="cards" class="mb-5"></section>

  <section id="secArm" class="data-section">
    <div class="data-section-header">
      <h2 class="data-section-title">ARMAZÉM</h2>
      <span id="rowsArm" class="text-xs text-slate-500" aria-live="polite"></span>
    </div>
    <div class="data-section-content overflow-x-auto">
      <table class="kpi"><thead id="theadArm"></thead><tbody id="tbodyArm"></tbody></table>
    </div>
  </section>

  <section id="secRH" class="data-section hidden">
    <div class="data-section-header">
      <h2 class="data-section-title">RH</h2>
      <span id="rowsRH" class="text-xs text-slate-500" aria-live="polite"></span>
    </div>
    <div class="data-section-content overflow-x-auto">
      <table class="kpi"><thead id="theadRH"></thead><tbody id="tbodyRH"></tbody></table>
    </div>
  </section>

  <section id="secTransp" class="data-section hidden">
    <div class="data-section-header">
      <h2 class="data-section-title">TRANSPORTE</h2>
      <span id="rowsTransp" class="text-xs text-slate-500" aria-live="polite"></span>
    </div>
    <div class="data-section-content overflow-x-auto">
      <table class="kpi"><thead id="theadTransp"></thead><tbody id="tbodyTransp"></tbody></table>
    </div>
  </section>
</main>

<dialog id="modalMetas" class="rounded-2xl p-0 w-[560px] max-w-[95vw] shadow-lg border border-slate-200">
  <form method="dialog" class="bg-white rounded-2xl">
    <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
      <h3 class="text-md font-semibold text-[var(--brand-primary)]">Metas de KPI</h3>
      <button id="closeMetas" class="btn" type="button">Fechar</button>
    </div>
    <div class="p-4 grid grid-cols-2 gap-3 text-xs">
      <label class="grid gap-1"><span>ON TIME D-1 (%)</span><input id="m_onTime" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IN FULL D-1 (%)</span><input id="m_inFull" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>FILL RATE D-1 (%)</span><input id="m_fillRate" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Contagem cíclica</span><input id="m_contagem" type="number" min="0" step="1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>ILA (%)</span><input id="m_ila" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IRA (%)</span><input id="m_ira" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Perdas (%)</span><input id="m_perdas" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Ocupação (%)</span><input id="m_ocupacao" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Turnover (%)</span><input id="m_turnover" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Absenteísmo (%)</span><input id="m_abs" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
    </div>
    <div class="px-4 py-3 border-t border-slate-100 flex justify-end gap-2 bg-slate-50">
      <button id="btnSalvarMetas" class="btn btn-primary" type="button">Salvar metas</button>
    </div>
  </form>
</dialog>

<dialog id="modalFarol" class="rounded-2xl p-0 w-[1200px] max-w-[96vw]">
  <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
    <div class="hdr px-4 py-3 flex items-center justify-between">
      <div class="text-sm font-semibold">Farol de Preenchimento — Visão rápida</div>
      <div class="flex items-center gap-3 faro-legend">
        <span class="chip"><span class="dot g"></span> Preenchido</span>
        <span class="chip"><span class="dot y"></span> Parcial (bloco)</span>
        <span class="chip"><span class="dot r"></span> Faltando</span>
        <button id="btnCloseFarol" class="chip" type="button">Fechar ✕</button>
      </div>
    </div>
    <div class="px-4 py-3 text-sm text-slate-600" id="farolHeaderInfo">—</div>
    <div class="px-4 pb-3 flex items-center gap-3">
      <label class="text-sm flex items-center gap-2">Unidades:
        <input id="farolFilter" class="minimal-input" placeholder="Filtrar por nome (ex.: CWB3, FOR, ...)" />
      </label>
      <label class="switch text-sm"><input id="farolOnlyMissing" type="checkbox"/> Mostrar apenas faltando</label>
      <button id="btnFarolPrint" class="btn">Imprimir / Copiar</button>
    </div>
    <div class="px-4 pb-5 overflow-auto">
      <table class="tbl-farol w-full">
        <thead>
          <tr>
            <th class="rounded-tl-lg w-[22%]">Unidade</th>
            <th>Armazém (D-1)</th>
            <th>RH (D-1)</th>
            <th>Transporte (D)</th>
            <th class="rounded-tr-lg">Transporte (D-1)</th>
          </tr>
        </thead>
        <tbody id="farolBody"></tbody>
      </table>
    </div>
  </div>
</dialog>

<script id="seed-data" type="application/json">[]</script>

<script>
/* ===== CONFIG ===== */
const LS_METAS='kpiTargets_blue_v1';
const defaultTargets={onTime:95,inFull:95,fillRate:95,contagem:95,ila:95,ira:95,perdas:8,ocupacao:85,turnover:3,abs:3};
const ROUTES={arm:'arm',rh:'rh',transp:'transp'}; let activeBlock=ROUTES.arm;

const EXCEL_URL = "data/BI Operacional_Catering.xlsx";
const EXCEL_SHEET = null;

/* COLUNAS */
const HEAD_ARM=["Unidade","Data","Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica","ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferença de estoque)"];
const HEAD_RH=["Unidade","Data","HE armazém e transporte","Turnover","Absenteísmo","Custo MOT (armazém e transporte)"];
const HEAD_TRANSP=["Unidade","Data","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","% On-time (calc)","Volume (tons)","Ocupação","Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Indisponibilidade de Frota (%)"];

/* (NOVO) Rótulos compactos para cabeçalho (display) */
const HEAD_LABELS = {
  "Largada (Total de veículos)": "Largada<br><small>(Total de veículos)</small>",
  "Largada (Veículos que saíram no horario)": "Largada<br><small>(no horário)</small>",
  "% On-time (calc)": "% On-time<br><small>(calc)</small>",
  "Volume (tons)": "Volume<br><small>(tons)</small>",
  "Ocupação": "Ocupação",
  "Reentrega": "Reentrega",
  "ON TIME D-1": "ON TIME<br><small>D-1</small>",
  "IN FULL D-1": "IN FULL<br><small>D-1</small>",
  "FILL RATE D-1": "FILL RATE<br><small>D-1</small>",
  "Ocorrências quantidade D-1": "Ocorrências<br><small>qtd D-1</small>",
  "Ocorrências em R$ D-1": "Ocorrências<br><small>R$ D-1</small>",
  "Indisponibilidade de Frota (%)": "Indisp.<br><small>Frota (%)</small>"
};

/* TIPAGEM/FORMATO */
const pctCols=new Set(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
const intCols=new Set(["Paletes Pendentes","Horas Extras Armazém","Horas Extras Transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1"]);
const moneyCols=new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
const tonsCols=new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const kgCols=new Set(["Corte (KG)"]);

/* ==== UTILS ==== */
const isDash = v => typeof v === 'string' && v.trim().match(/^[-–—]+$/);
const toISODateLocal = (y,m,d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
const fmt={
  num:v=>(v??v===0)?Number(v).toLocaleString('pt-BR'):'',
  money:v=>(v??v===0)?Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}):'',
  pct:v=>(v??v===0)?`${Number(v).toFixed(1).replace('.',',')}%`:'',
  date:s=>!s?'':String(s).replace(/^(\d{4})-(\d{2})-(\d{2})$/,(a,Y,M,D)=>`${D}/${M}/${Y}`)
};
const parseDateRaw = s=>{
  if(!s) return new Date('invalid');
  const iso=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
  const dmY=String(s).match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(dmY) return new Date(+dmY[3],+dmY[2]-1,+dmY[1]);
  return new Date(s);
};
const asNumber=(v)=>{ if(v===null||v===undefined) return ''; const s=String(v).trim(); if(s===''||isDash(s)) return ''; const n=Number(s.replace(/R\$\s?/i,'').replace(/\./g,'').replace(',','.').replace(/%/g,'')); return Number.isFinite(n)?n:''; };
const asDateISO=(v)=>{ if(v==null||v===''||isDash(v)) return ''; if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v); if(!d) return ''; return toISODateLocal(d.y,d.m,d.d);} const s=String(v).trim(); const m=s.match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(m) return toISODateLocal(+m[3],+m[2],+m[1]); const dt=new Date(s); return isNaN(dt)?'':toISODateLocal(dt.getFullYear(),dt.getMonth()+1,dt.getDate()); };

/* ✅ Default dates: início = ontem (D-1), fim = hoje */
function setDatesDefaultToYesterday(){
  const today = new Date();
  const yesterday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1);
  dateStart.value = toISODateLocal(yesterday.getFullYear(), yesterday.getMonth()+1, yesterday.getDate());
  dateEnd.value   = toISODateLocal(today.getFullYear(), today.getMonth()+1, today.getDate());
}

function normPct(v){
  if(v===''||v==null) return '';
  let n=Number(String(v).replace('%','').replace(/\s/g,'').replace(',','.'));
  if(!Number.isFinite(n)) return '';
  if(n>0 && n<=1) return n*100;
  if(n<=100) return n;
  while(n>100) n/=10;
  return n;
}

function getSeedData(){
  const el=document.getElementById('seed-data');
  if(!el) return [];
  let raw=[]; try{ raw = JSON.parse(el.textContent||'[]'); }catch(e){ return []; }
  if(!Array.isArray(raw) || !raw.length) return [];
  return raw.map(normalizeRow).filter(o=>!isRowAllBlank(o));
}
let DATA = getSeedData();

const els={dateStart:document.getElementById('dateStart'),dateEnd:document.getElementById('dateEnd'),csvInput:document.getElementById('csvInput'),btnMetas:document.getElementById('btnMetas'),modalMetas:document.getElementById('modalMetas'),closeMetas:document.getElementById('closeMetas'),btnSalvarMetas:document.getElementById('btnSalvarMetas'),btnReset:document.getElementById('btnReset'),metasBadges:document.getElementById('metasBadges'),cards:document.getElementById('cards'),unitsBar:document.getElementById('unitsBar'),tabArm:document.getElementById('tabArm'),tabRH:document.getElementById('tabRH'),tabTransp:document.getElementById('tabTransp'),secArm:document.getElementById('secArm'),secRH:document.getElementById('secRH'),secTransp:document.getElementById('secTransp'),theadArm:document.getElementById('theadArm'),tbodyArm:document.getElementById('tbodyArm'),theadRH:document.getElementById('theadRH'),tbodyRH:document.getElementById('tbodyRH'),theadTransp:document.getElementById('theadTransp'),tbodyTransp:document.getElementById('tbodyTransp'),rowsArm:document.getElementById('rowsArm'),rowsRH:document.getElementById('rowsRH'),rowsTransp:document.getElementById('rowsTransp')};
const {dateStart,dateEnd,csvInput,btnMetas,modalMetas,closeMetas,btnSalvarMetas,btnReset,metasBadges,cards,unitsBar,tabArm,tabRH,tabTransp,secArm,secRH,secTransp,theadArm,tbodyArm,theadRH,tbodyRH,theadTransp,tbodyTransp,rowsArm,rowsRH,rowsTransp}=els;

let UNIT_STATE=[];
function renderUnits(list){
  const units=Array.from(new Set(list.map(r=>r.Unidade))).sort();
  const prev=new Map(UNIT_STATE.map(x=>[x.u,x.on]));
  UNIT_STATE=units.map(u=>({u,on:prev.has(u)?prev.get(u):true}));
  unitsBar.innerHTML='';
  const allBtn=document.createElement('button'); allBtn.type='button'; allBtn.className='pill'; allBtn.textContent='Todas';
  allBtn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');
  allBtn.addEventListener('click',()=>{const makeOn=!UNIT_STATE.every(x=>x.on); UNIT_STATE.forEach(x=>x.on=makeOn); updateUnitPills(); refresh();});
  unitsBar.appendChild(allBtn);
  units.forEach(u=>{const b=document.createElement('button'); b.type='button'; b.className='pill'; b.textContent=u; b.dataset.u=u;
    b.setAttribute('aria-pressed', UNIT_STATE.find(x=>x.u===u)?.on?'true':'false');
    b.addEventListener('click',()=>{const item=UNIT_STATE.find(x=>x.u===u); item.on=!item.on; updateUnitPills(); refresh();});
    unitsBar.appendChild(b);
  });
}
function updateUnitPills(){unitsBar.querySelectorAll('.pill').forEach(btn=>{ if(btn.textContent==='Todas'){btn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');} else {const on=UNIT_STATE.find(x=>x.u===btn.dataset.u)?.on; btn.setAttribute('aria-pressed', on?'true':'false');}});}
function selectedUnits(){return UNIT_STATE.filter(x=>x.on).map(x=>x.u);}

function applyFilters(data){
  let out=data.slice();
  const ds=dateStart.value?parseDateRaw(dateStart.value):null;
  const de=dateEnd.value?parseDateRaw(dateEnd.value):null;
  if(ds) out=out.filter(r=>parseDateRaw(r.Data)>=ds);
  if(de){const e=new Date(de); e.setHours(23,59,59,999); out=out.filter(r=>parseDateRaw(r.Data)<=e);}
  const units=selectedUnits();
  if(units.length && units.length!==UNIT_STATE.length) out=out.filter(r=>units.includes(r.Unidade));
  return out;
}

function enrich(r){
  const vin=asNumber(r["Volume In (tons)"])||0, vout=asNumber(r["Volume Out (tons)"])||0;
  if(vin>0||vout>0) r["Volume (tons)"]= r["Volume (tons)"]!=='' ? r["Volume (tons)"] : (vin+vout);
  const hea=asNumber(r["Horas Extras Armazém"]), het=asNumber(r["Horas Extras Transporte"]);
  r["HE armazém e transporte"]=(hea!==''||het!=='')?((hea||0)+(het||0)):'';
  const lt=asNumber(r["Largada (Total de veículos)"])||0, ln=asNumber(r["Largada (Veículos que saíram no horario)"])||0;
  r["% On-time (calc)"]=lt>0?(ln/lt)*100:'';
  if(r["Custo MOT (armazém e transporte)"]===''||r["Custo MOT (armazém e transporte)"]==null) r["Custo MOT (armazém e transporte)"]='';
  return r;
}
function summarize(list){
  const acc={count:list.length,sum:{},avg:{}};
  const sumCols=["Volume In (tons)","Volume Out (tons)","Volume (tons)","Corte (KG)","Paletes Pendentes","Horas Extras Armazém","Horas Extras Transporte","HE armazém e transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"];
  const avgCols=["Contagem cíclica","ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"];
  sumCols.forEach(k=>acc.sum[k]=0); avgCols.forEach(k=>acc.avg[k]=0);
  list.forEach(r=>{ sumCols.forEach(k=>acc.sum[k]+=Number(r[k])||0); avgCols.forEach(k=>{const v=Number(r[k]); if(!isNaN(v)) acc.avg[k]+=v;}); });
  avgCols.forEach(k=>{const validCount = list.filter(r => !isNaN(Number(r[k])) && r[k] !== '').length; acc.avg[k] = validCount ? acc.avg[k] / validCount : null;});
  const lt=acc.sum["Largada (Total de veículos)"], ln=acc.sum["Largada (Veículos que saíram no horario)"];
  if(lt>0) acc.avg["% On-time (calc)"]=(ln/lt)*100;
  return acc;
}

const targetMap={"Contagem cíclica":{k:"contagem",inverse:false},"ILA %":{k:"ila",inverse:false},"IRA %":{k:"ira",inverse:false},"Perdas (avarias e diferença de estoque)":{k:"perdas",inverse:true},"Turnover":{k:"turnover",inverse:true},"Absenteísmo":{k:"abs",inverse:true},"Ocupação":{k:"ocupacao",inverse:false},"ON TIME D-1":{k:"onTime",inverse:false},"IN FULL D-1":{k:"inFull",inverse:false},"FILL RATE D-1":{k:"fillRate",inverse:false},"% On-time (calc)":{k:"onTime",inverse:false}};
const getTargets=()=>{const raw=localStorage.getItem(LS_METAS);return raw?{...defaultTargets,...JSON.parse(raw)}:{...defaultTargets}};
const saveTargets=t=>localStorage.setItem(LS_METAS,JSON.stringify(t));
function statusOf(metric,value){ const t=getTargets(); const conf=targetMap[metric]; if(!conf) return 'neutral'; const target=Number(t[conf.k]); if(isNaN(target)||value==null||value==='') return 'neutral'; if(!conf.inverse){ if(value>=target) return 'ok'; if(value>=target*0.95) return 'warn'; return 'bad'; } else { if(value<=target) return 'ok'; if(value<=target*1.10) return 'warn'; return 'bad'; } }

function renderBadges(){ const t=getTargets(); const items=[["On-time",t.onTime],["Fill Rate",t.fillRate],["In Full",t.inFull],["Contagem",t.contagem],["ILA",t.ila],["IRA",t.ira],["Perdas (máx)",t.perdas],["Ocupação",t.ocupacao],["Turnover (máx)",t.turnover],["Absenteísmo (máx)",t.abs]]; metasBadges.innerHTML=''; items.forEach(([k,v])=>{const s=document.createElement('span'); s.className='pill'; s.textContent=`${k}: ${v}%`; metasBadges.appendChild(s);}); }

/* (ALTERADO) Cabeçalho com rótulos compactos e quebras */
function renderHead(theadEl, HEADERS){
  const tr = document.createElement('tr');
  HEADERS.forEach((h,i)=>{
    const th = document.createElement('th');
    th.className = (i===0?'col-unidade' : i===1?'col-data':'col-num');
    const label = HEAD_LABELS[h] || h;  // pode conter <br> e <small>
    th.innerHTML = label;
    tr.appendChild(th);
  });
  theadEl.innerHTML = '';
  theadEl.appendChild(tr);
}

function cardHTML(label,value,type,metricKeyForStatus){
  let txt='';
  if(type==='money')       txt=fmt.money(value);
  else if(type==='pct')    txt=fmt.pct(value);
  else                     txt=fmt.num(value);
  const st=metricKeyForStatus?statusOf(metricKeyForStatus,Number(value)):'neutral';
  const valueCls = `mt-1 card-value ${type==='money' ? ' is-money' : ''}`;
  return `<div class="kpi-card ${st}">
            <div class="card-label">${label}</div>
            <div class="${valueCls}">${txt||'–'}</div>
          </div>`;
}
function renderCardsFor(block,sum){
  let cardsArr=[];
  if(block===ROUTES.arm){
    cardsArr=[['Volume In(t)',sum.sum["Volume In (tons)"],'num',null],['Volume Out(t)',sum.sum["Volume Out (tons)"],'num',null],['Corte(KG)',sum.sum["Corte (KG)"],'num',null],['Contagem cíclica',sum.avg["Contagem cíclica"],'num',"Contagem cíclica"],['ILA %',sum.avg["ILA %"],'pct',"ILA %"],['IRA %',sum.avg["IRA %"],'pct',"IRA %"],['Paletes Pendentes',sum.sum["Paletes Pendentes"],'num',null],['Perdas (%)',sum.avg["Perdas (avarias e diferença de estoque)"],'pct',"Perdas (avarias e diferença de estoque)"]];
  }else if(block===ROUTES.rh){
    cardsArr=[['HE total',sum.sum["HE armazém e transporte"],'num',null],['Turnover %',sum.avg["Turnover"],'pct',"Turnover"],['Absenteísmo %',sum.avg["Absenteísmo"],'pct',"Absenteísmo"],['Custo MOT (R$)',sum.sum["Custo MOT (armazém e transporte)"],'money',null]];
  }else{
    cardsArr=[['Largada total',sum.sum["Largada (Total de veículos)"],'num',null],['No horário',sum.sum["Largada (Veículos que saíram no horario)"],'num',null],['% Largada',sum.avg["% On-time (calc)"],'pct',"% On-time (calc)"],['Volume (t)',sum.sum["Volume (tons)"],'num',null],['Ocupação %',sum.avg["Ocupação"],'pct',"Ocupação"],['Reentrega',sum.sum["Reentrega"],'num',null],['On time D-1%',sum.avg["ON TIME D-1"],'pct',"ON TIME D-1"],['In full D-1%',sum.avg["IN FULL D-1"],'pct',"IN FULL D-1"],['Fill rate D-1%',sum.avg["FILL RATE D-1"],'pct',"FILL RATE D-1"],['Indisp. Frota %',sum.avg["Indisponibilidade de Frota (%)"],'pct',null],['Ocorrências R$',sum.sum["Ocorrências em R$ D-1"],'money',null],['Ocorrências',sum.sum["Ocorrências quantidade D-1"],'num',null]];
  }
  cards.innerHTML=cardsArr.map(c=>cardHTML(c[0],c[1],c[2],c[3])).join('');
}
function renderBody(tbodyEl,HEADERS,list,rowsInfoEl){
  const frag=document.createDocumentFragment();
  list.forEach(r=>{
    const tr=document.createElement('tr');
    HEADERS.forEach((h)=>{
      let v=r[h];
      if(h==="Data") v=fmt.date(v);
      if(h==="Volume (tons)"&&(v==null||v==='')){ const vin=asNumber(r["Volume In (tons)"])||0; const vout=asNumber(r["Volume Out (tons)"])||0; if(vin>0||vout>0) v=vin+vout; }
      let txt=''; if(pctCols.has(h)) txt=fmt.pct(v); else if(moneyCols.has(h)) txt=fmt.money(v);
      else if(kgCols.has(h)||tonsCols.has(h)||intCols.has(h)) txt=fmt.num(v); else txt=(v??'')+'';
      const st=statusOf(h,Number(v));
      const td=document.createElement('td'); 
      if(st !== 'neutral') {
          td.style.backgroundColor = `var(--status-${st}-bg)`;
          td.style.color = `var(--status-${st}-fg)`;
          td.style.fontWeight = '500';
      }
      td.textContent=txt; 
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbodyEl.innerHTML=''; tbodyEl.appendChild(frag);
  if(rowsInfoEl) rowsInfoEl.textContent=list.length+" linha(s)";
}

function getActiveFromHash(){ const h=(location.hash||'#arm').replace('#',''); if(h===ROUTES.rh) return ROUTES.rh; if(h===ROUTES.transp) return ROUTES.transp; return ROUTES.arm; }

function setActiveBlock(block){ 
  activeBlock=block; 
  if (block === ROUTES.arm) {
    cards.className = 'mb-5 grid grid-cols-2 sm:grid-cols-4 xl:grid-cols-8 gap-3';
  } else if (block === ROUTES.transp) {
    cards.className = 'mb-5 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3';
  } else {
    cards.className = 'mb-5 grid grid-cols-2 md:grid-cols-4 gap-3';
  }
  tabArm.setAttribute('aria-current',block===ROUTES.arm?'page':'false'); 
  tabRH.setAttribute('aria-current',block===ROUTES.rh?'page':'false'); 
  tabTransp.setAttribute('aria-current',block!==ROUTES.transp?'false':'page'); 
  secArm.classList.toggle('hidden',block!==ROUTES.arm); 
  secRH.classList.toggle('hidden',block!==ROUTES.rh); 
  secTransp.classList.toggle('hidden',block!==ROUTES.transp); 
  refresh(); 
}
window.addEventListener('hashchange',()=>setActiveBlock(getActiveFromHash()));

/* sets */
const PCT = new Set(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
const MONEY = new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
const INTLIKE = new Set(["Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Horas Extras Armazém","Horas Extras Transporte"]);
const TONS = new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const KEY_NUMERIC = new Set(["Volume In (tons)","Volume Out (tons)","Corte (KG)","Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Contagem cíclica","ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Indisponibilidade de Frota (%)","Volume (tons)"]);

const normalizeRow=(row)=>{
  const o={};
  for(const k in row){ const key=String(k).trim(); const val=isDash(row[k])?'':row[k]; o[key]=val; }
  if(o["Indisponibilidade de Frota"]!==undefined && o["Indisponibilidade de Frota (%)"]===undefined) o["Indisponibilidade de Frota (%)"]=o["Indisponibilidade de Frota"];
  o["Data"]=asDateISO(o["Data"]);

  Object.keys(o).forEach(k=>{
    if(PCT.has(k)) { o[k]=normPct(o[k]); return; }
    if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
    if(k==="Contagem cíclica"){ const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
  });

  if(o["Volume (tons)"]===''||o["Volume (tons)"]==null){
    const vin=asNumber(o["Volume In (tons)"])||0, vout=asNumber(o["Volume Out (tons)"])||0;
    o["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):'';
  }
  return o;
};
const isRowAllBlank=(o)=>{
  if(!o["Unidade"]||!o["Data"]) return true;
  for(const k of KEY_NUMERIC){ const v=o[k]; if(v!=='' && Number(v)!==0) return false; }
  return true;
};

function parseCSV(text){
  const delimiter=text.indexOf(';')>-1?';':',';
  const lines=text.trim().split(/\r?\n/);
  const headers=lines[0].split(delimiter).map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols=[]; let cur='',inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){inQ=!inQ;continue;} if(!inQ&&ch===delimiter){cols.push(cur);cur='';continue;} cur+=ch; }
    cols.push(cur);
    const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]!==undefined?cols[i].trim():'');
    Object.keys(obj).forEach(k=>{ if(isDash(obj[k])) obj[k]=''; });
    if(obj["Data"] && /^\d{2}[./]\d{2}[./]\d{4}$/.test(obj["Data"])){ const [d,m,y]=obj["Data"].replace(/\./g,'/').split('/').map(Number); obj["Data"]=toISODateLocal(y,m,d); }
    Object.keys(obj).forEach(k=>{
      if(PCT.has(k)) { obj[k]=normPct(obj[k]); return; }
      if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; }
      if(k==="Contagem cíclica"){ const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; } /* fix */
    });
    if(obj["Volume (tons)"]===undefined||obj["Volume (tons)"]===''){ const vin=asNumber(obj["Volume In (tons)"])||0, vout=asNumber(obj["Volume Out (tons)"])||0; obj["Volume (tons)"]=(vin+vout)||''; }
    return obj;
  });
}

function openMetas(){const t=getTargets(); m_onTime.value=t.onTime; m_inFull.value=t.inFull; m_fillRate.value=t.fillRate; m_contagem.value=t.contagem; m_ila.value=t.ila; m_ira.value=t.ira; m_perdas.value=t.perdas; m_ocupacao.value=t.ocupacao; m_turnover.value=t.turnover; m_abs.value=t.abs; modalMetas.showModal();}
function saveMetas(){ const t={onTime:+(m_onTime.value||defaultTargets.onTime),inFull:+(m_inFull.value||defaultTargets.inFull),fillRate:+(m_fillRate.value||defaultTargets.fillRate),contagem:+(m_contagem.value||defaultTargets.contagem),ila:+(m_ila.value||defaultTargets.ila),ira:+(m_ira.value||defaultTargets.ira),perdas:+(m_perdas.value||defaultTargets.perdas),ocupacao:+(m_ocupacao.value||defaultTargets.ocupacao),turnover:+(m_turnover.value||defaultTargets.turnover),abs:+(m_abs.value||defaultTargets.abs)}; saveTargets(t); renderBadges(); refresh(); modalMetas.close(); }

const hasAnyForHeaders=(row,HEADERS)=> HEADERS.slice(2).some(h=>{ const v=row[h]; if(v===''||v==null) return false; const n=Number(v); return Number.isFinite(n)?true:String(v).trim()!==''; });
function renderHeadsOnce(){ if(!theadArm.hasChildNodes()) renderHead(theadArm,HEAD_ARM); if(!theadRH.hasChildNodes()) renderHead(theadRH,HEAD_RH); if(!theadTransp.hasChildNodes()) renderHead(theadTransp,HEAD_TRANSP); }

function refresh(){
  const enriched=DATA.map(r=>enrich({...r}));
  const filtered=applyFilters(enriched);
  const HEADERS=activeBlock===ROUTES.arm?HEAD_ARM:(activeBlock===ROUTES.rh?HEAD_RH:HEAD_TRANSP);
  const filteredForBlock=filtered.filter(r=>hasAnyForHeaders(r,HEADERS));
  const sum=summarize(filteredForBlock);
  renderBadges(); renderHeadsOnce(); renderCardsFor(activeBlock,sum);
  if(activeBlock===ROUTES.arm) renderBody(tbodyArm,HEAD_ARM,filteredForBlock,rowsArm);
  else if(activeBlock===ROUTES.rh) renderBody(tbodyRH,HEAD_RH,filteredForBlock,rowsRH);
  else renderBody(tbodyTransp,HEAD_TRANSP,filteredForBlock,rowsTransp);
  buildAndRenderFarol();
}

async function loadExcelFromRepo(){
  try{
    const res = await fetch(EXCEL_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`Não encontrei ${EXCEL_URL} (HTTP ${res.status})`);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error(`Aba não encontrada: ${EXCEL_SHEET||'(primeira aba)'}`);
    const ref = XLSX.utils.decode_range(ws['!ref']);
    ref.s.r = Math.max(ref.s.r, 2);
    ref.s.c = Math.max(ref.s.c, 1);
    const newRef = XLSX.utils.encode_range(ref);
    let rows = XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows = rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    if(!rows.length) throw new Error("Planilha vazia após normalização.");
    DATA = rows;
    console.log('CARREGADO_DO_REPO:', {linhas: DATA.length, aba: (EXCEL_SHEET||wb.SheetNames[0])});
  }catch(err){
    console.warn("Falha ao carregar Excel do repositório:", err);
  }
}

function bootstrap(){
  const hasData = Array.isArray(DATA) && DATA.length>0;
  const afterDataReady = ()=>{
    renderUnits(DATA);
    /* ✅ Sempre: início = ontem, fim = hoje */
    setDatesDefaultToYesterday();
    setActiveBlock(getActiveFromHash());
    if(!location.hash) history.replaceState(null,'','#'+activeBlock);
    buildAndRenderFarol();
  };
  if(hasData){ afterDataReady(); } else { loadExcelFromRepo().then(afterDataReady); }
}

dateStart.addEventListener('change',refresh);
dateEnd.addEventListener('change',refresh);
btnReset.addEventListener('click',()=>{ dateStart.value=''; dateEnd.value=''; UNIT_STATE.forEach(x=>x.on=true); updateUnitPills(); refresh(); });
btnMetas.addEventListener('click',openMetas);
closeMetas.addEventListener('click',e=>{e.preventDefault();modalMetas.close();});
btnSalvarMetas.addEventListener('click',e=>{e.preventDefault();saveMetas();});
modalMetas.addEventListener('cancel',()=>modalMetas.close());

csvInput.addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  if(/\.(xlsx|xls)$/i.test(f.name)){
    const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets['Base']||wb.Sheets[wb.SheetNames[0]];
    const ref=XLSX.utils.decode_range(ws['!ref']); ref.s.r=Math.max(ref.s.r,2); ref.s.c=Math.max(ref.s.c,1); const newRef=XLSX.utils.encode_range(ref);
    let rows=XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows=rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    DATA=rows; console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
  }else{
    DATA=parseCSV(await f.text()).map(normalizeRow).filter(o=>!isRowAllBlank(o));
    console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
    if(!DATA.length) return alert('Arquivo vazio ou inválido.');
  }
  renderUnits(DATA); updateUnitPills();

  /* ✅ Ao importar arquivo: início = ontem, fim = hoje */
  setDatesDefaultToYesterday();

  refresh();
});

bootstrap();

/* Header stuck shadow */
(function(){
  const hdr=document.getElementById('appHeader');
  const onScroll=()=>{ const y=window.scrollY||document.documentElement.scrollTop; hdr.classList.toggle('is-stuck', y>2); };
  document.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
})();

/* ============ FAROL DE PREENCHIMENTO ============ */
const FAROL_FIELDS = {
  ARM_D1: ["Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica","ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferença de estoque)"],
  RH_D1: ["HE armazém e transporte","Turnover","Absenteísmo","Custo MOT (armazém e transporte)"],
  TRANS_D: ["Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Ocupação"],
  TRANS_D1: ["ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorrências quantidade D-1","Ocorrências em R$ D-1"],
};
function getAnchorDates(today=new Date()){
  const D = new Date(today.getFullYear(),today.getMonth(),today.getDate());
  const dow = D.getDay();
  const D1 = new Date(D);
  if(dow===1){ D1.setDate(D.getDate()-3); } else { D1.setDate(D.getDate()-1); }
  const toISO=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  return {D_iso:toISO(D), D1_iso:toISO(D1)};
}
function mergeFirstNonEmpty(rows, fields){
  const out={};
  fields.forEach(f=>out[f]='');
  for(const r of rows){ for(const f of fields){ if(out[f]==='' && (r[f]!=='' && r[f]!==null && r[f]!==undefined)) out[f]=r[f]; } }
  return out;
}
function statusFor(unit, isoDate, fields){
  const rows = DATA.filter(r=>r.Unidade===unit && r.Data===isoDate);
  if(!rows.length) return 'missing';
  const merged = mergeFirstNonEmpty(rows, fields);
  const vals = fields.map(f=>merged[f]);
  const hasAny = vals.some(v=>v!=='' && v!==null && v!==undefined);
  if(!hasAny) return 'missing';
  const allHas = vals.every(v=>v!=='' && v!==null && v!==undefined);
  return allHas ? 'ok' : 'partial';
}
function buildAndRenderFarol(){
  const {D_iso,D1_iso} = getAnchorDates(new Date());
  const units = Array.from(new Set(applyFilters(DATA).map(r=>r.Unidade))).sort();
  const rows = units.map(u=>{ return { unidade:u, arm: statusFor(u,D1_iso,FAROL_FIELDS.ARM_D1), rh:  statusFor(u,D1_iso,FAROL_FIELDS.RH_D1), td:  statusFor(u,D_iso,FAROL_FIELDS.TRANS_D), td1: statusFor(u,D1_iso,FAROL_FIELDS.TRANS_D1), }; });
  renderFarol(rows, D_iso, D1_iso);
}
function renderFarol(data, D_iso, D1_iso){
  const body = document.getElementById('farolBody');
  const info = document.getElementById('farolHeaderInfo');
  info.textContent = `D = ${fmt.date(D_iso)} | D-1 = ${fmt.date(D1_iso)} | Unidades: ${data.length}`;
  function dot(c){ const map={ok:'g',partial:'y',missing:'r'}; return `<span class="dot ${map[c]||'r'}"></span>`; }
  function rowHTML(r){ return `<tr><td class="font-medium text-[13px]">${r.unidade}</td><td><div class="cell-dot">${dot(r.arm)}</div></td><td><div class="cell-dot">${dot(r.rh)}</div></td><td><div class="cell-dot">${dot(r.td)}</div></td><td><div class="cell-dot">${dot(r.td1)}</div></td></tr>`; }
  const filterEl = document.getElementById('farolFilter');
  const onlyMissingEl = document.getElementById('farolOnlyMissing');
  function applyView(){
    const q = (filterEl.value||'').trim().toLowerCase();
    const onlyMissing = !!onlyMissingEl.checked;
    let list = data.slice();
    if(q) list = list.filter(r => r.unidade.toLowerCase().includes(q));
    if(onlyMissing) list = list.filter(r => !(r.arm==='ok' && r.rh==='ok' && r.td==='ok' && r.td1==='ok'));
    body.innerHTML = list.length? list.map(rowHTML).join('') : `<tr><td colspan="5" class="text-center text-slate-500 py-4">Sem dados</td></tr>`;
  }
  filterEl.oninput = applyView;
  onlyMissingEl.onchange = applyView;
  applyView();
  document.getElementById('btnFarolPrint').onclick = ()=>{ window.print(); }
}

(function(){
  const btn = document.createElement('button');
  btn.className='fab'; btn.id='btnFarol'; btn.textContent='Ver Farol';
  document.body.appendChild(btn);
  const modalFarol = document.getElementById('modalFarol');
  btn.addEventListener('click',()=> modalFarol.showModal());
  document.getElementById('btnCloseFarol').addEventListener('click',()=> modalFarol.close());
  modalFarol.addEventListener('cancel',()=> modalFarol.close());
})();
</script>

<style>
  .insights-fab{
    position:fixed;right:18px;bottom:calc(var(--safe-bottom) + 68px);z-index:9998;
    padding:.9rem 1.1rem;border-radius:999px;border:0;background:var(--brand-primary);
    color:#fff;font-weight:600;box-shadow:var(--shadow-lg);cursor:pointer; transition: transform .2s ease-out;
  }
  .insights-fab:hover { transform: scale(1.05); }
  .insights-fab:focus-visible { outline:none; box-shadow:0 0 0 3px var(--brand-primary-light), 0 0 0 1.5px var(--brand-primary); }

  .insights-panel{
    position:fixed;right:18px;bottom:calc(var(--safe-bottom) + 136px);z-index:9998;
    width:min(720px,92vw);max-height:75vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 20px 40px rgba(2,6,23,.18)
  }
  .insights-panel header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef2ff;background:linear-gradient(90deg,var(--brand-primary-dark),var(--brand-primary));color:#fff;border-top-left-radius:16px;border-top-right-radius:16px}
  .insights-panel section{padding:14px 16px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:.18rem .5rem;border-radius:999px;border:1px solid #e5e7eb;font-size:12px;background:#f8fafc;color:#0f172a}

  .insights-panel .ok{color:#065f46}
  .insights-panel .warn{color:#92400e}
  .insights-panel .bad{color:#991b1b}

  .list{margin:8px 0 0 0;padding-left:16px}
  .list li{margin:4px 0}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-bottom-width:2px;padding:.05rem .35rem;border-radius:6px}
</style>

<button class="insights-fab" id="btnInsights">Analisar KPIs</button>
<div class="insights-panel" id="panelInsights" style="display:none" role="dialog" aria-modal="true" aria-labelledby="insightsTitle">
  <header>
    <strong id="insightsTitle">Insights automáticos — KPIs</strong>
    <button id="closeInsights" class="chip" title="Fechar">Fechar ✕</button>
  </header>
  <section id="insightsContent">
    <div class="chip">Lendo KPIs da tela…</div>
  </section>
</div>

<script>
(()=>{
const THRESH = {ONTIME_OK:95, ONTIME_CRIT:90, INFULL_OK:95, INFULL_CRIT:90, FILL_OK:98, FILL_CRIT:95, ILA_OK:100, IRA_OK:100, PERDAS_WARN:0.3, PERDAS_CRIT:1.0, OCUP_OK_MIN:85, OCUP_OK_MAX:95, TURNOVER_WARN:5, TURNOVER_CRIT:10, ABSENT_WARN:3, ABSENT_CRIT:5};
const pct = v => (v!=null && !Number.isNaN(v)) ? `${v.toFixed(2)}%` : "—";
function toNum(s){ if(!s) return NaN; const m=String(s).replace(/\s/g,'').match(/-?\d+(?:[\.,]\d+)?/); if(!m) return NaN; return parseFloat(m[0].replace('.','').replace(',','.')); }
function findClosestPercentage(el){ const text=(el.innerText||"")+" "+([...el.querySelectorAll('*')].map(e=>e.innerText).join(' ')||""); let m=text.match(/-?\d{1,3}(?:[\.,]\d+)?\s*%/); if(m) return toNum(m[0]); m=text.match(/-?\d{1,3}(?:[\.,]\d+)?/); if(m) return toNum(m[0]); return NaN; }
const LABELS=[{key:'onTime',re:/(on[\s-]?time|ontime)/i},{key:'inFull',re:/(in\s*full|infull|if\b)/i},{key:'fillRate',re:/(fill\s*rate|fillrate|fr\b)/i},{key:'ila',re:/\bila\b/i},{key:'ira',re:/\bira\b/i},{key:'perdas',re:/(perdas|avarias|diferen[çc]a\s*de\s*estoque)/i},{key:'ocupacao',re:/(ocupa[cç][aã]o|ocupacao)/i},{key:'turnover',re:/turnover/i},{key:'absenteismo',re:/(absent(e[i]s)?[ií]smo|absenteismo)/i},];
function collectKPIsFromDataAttrs(){ const out={}; document.querySelectorAll('[data-kpi]').forEach(el=>{ const key=String(el.getAttribute('data-kpi')||'').trim(); let v=el.getAttribute('data-value'); v=v!=null?toNum(v):findClosestPercentage(el); if(!Number.isNaN(v)) out[key]=v; }); return out; }
function collectKPIsFromLabels(){ const out={}; const all=[...document.querySelectorAll('body *')].filter(el=>el.children.length===0&&(el.innerText||'').trim().length>0); LABELS.forEach(({key,re})=>{ let best=null,bestDist=Infinity; all.forEach(el=>{ if(re.test(el.innerText)){ const v=findClosestPercentage(el); if(!Number.isNaN(v)){ const d=0; if(d<bestDist){best={el,v};bestDist=d;} }else{ const sibs=[...(el.parentElement?.children||[])]; for(const s of sibs){ const vv=findClosestPercentage(s); if(!Number.isNaN(vv)){ const d=1; if(d<bestDist){best={el:s,v:vv};bestDist=d;} } } } } }); if(best && !Number.isNaN(best.v)) out[key]=best.v; }); return out; }
function mergePriority(a,b){ return {...a, ...b}; }
function getKPIs(){ const byAttrs  = collectKPIsFromDataAttrs(); const byLabels = collectKPIsFromLabels(); return mergePriority(byLabels, byAttrs); }
function analyze(k){ const good=[],warn=[],bad=[],suggest=[]; const push=(arr,msg)=>arr.push(msg);
  const o=k.onTime; if(!Number.isNaN(o)){ if(o>=THRESH.ONTIME_OK) push(good,`On-time ${pct(o)} dentro/above da meta (≥ ${THRESH.ONTIME_OK}%).`); else if(o>=THRESH.ONTIME_CRIT){ push(warn,`On-time ${pct(o)} abaixo da meta. Meta: ${THRESH.ONTIME_OK}%.`); suggest.push(`Revisar causas de atraso (janela de corte, carga/descarga, rotas).`);} else{ push(bad,`On-time crítico em ${pct(o)} (< ${THRESH.ONTIME_CRIT}%).`); suggest.push(`Plano de ação imediato para atrasos recorrentes e gargalos.`);} }
  const inf=k.inFull; if(!Number.isNaN(inf)){ if(inf>=THRESH.INFULL_OK) push(good,`In-Full ${pct(inf)} saudável (≥ ${THRESH.INFULL_OK}%).`); else if(inf>=THRESH.INFULL_CRIT){ push(warn,`In-Full ${pct(inf)} pede atenção.`); suggest.push(`Checar rupturas/picking incompleto e acurácia de estoque.`);} else{ push(bad,`In-Full crítico em ${pct(inf)}.`); suggest.push(`Ação em causas-raiz: planejamento, estoque de segurança, SLA fornecedores.`);} }
  const fr=k.fillRate; if(!Number.isNaN(fr)){ if(fr>=THRESH.FILL_OK) push(good,`Fill Rate ${pct(fr)} excelente (≥ ${THRESH.FILL_OK}%).`); else if(fr>=THRESH.FILL_CRIT){ push(warn,`Fill Rate ${pct(fr)} abaixo do ideal.`); suggest.push(`Ajustar políticas de reposição e priorização de pedidos.`);} else{ push(bad,`Fill Rate ${pct(fr)} muito baixo.`); suggest.push(`Rever forecast e alinhamento comercial/logística.`);} }
  const ila=k.ila; if(!Number.isNaN(ila)){ if(ila>=THRESH.ILA_OK) push(good,`ILA ${pct(ila)} ok (alvo 100%).`); else{ push(warn,`ILA ${pct(ila)} abaixo de 100%.`); suggest.push(`Corrigir lançamentos/processos que afetam disponibilidade.`);} }
  const ira=k.ira; if(!Number.isNaN(ira)){ if(ira>=THRESH.IRA_OK) push(good,`IRA ${pct(ira)} ok (alvo 100%).`); else{ push(warn,`IRA ${pct(ira)} abaixo de 100%.`); suggest.push(`Atuar em recebimento, conferência e integridade dos itens.`);} }
  const perdas=k.perdas; if(!Number.isNaN(perdas)){ if(perdas<=THRESH.PERDAS_WARN) push(good,`Perdas ${pct(perdas)} controladas (≤ ${THRESH.PERDAS_WARN}%).`); else if(perdas<=THRESH.PERDAS_CRIT){ push(warn,`Perdas ${pct(perdas)} elevadas.`); suggest.push(`Foco em causas (avarias, validade, diferença de estoque).`);} else{ push(bad,`Perdas ${pct(perdas)} críticas.`); suggest.push(`Ação corretiva urgente (embalagem, manuseio, inventário).`);} }
  const oc=k.ocupacao; if(!Number.isNaN(oc)){ if(oc>=THRESH.OCUP_OK_MIN && oc<=THRESH.OCUP_OK_MAX) push(good,`Ocupação ${pct(oc)} saudável (${THRESH.OCUP_OK_MIN}–${THRESH.OCUP_OK_MAX}%).`); else if(oc>THRESH.OCUP_OK_MAX){ push(warn,`Ocupação ${pct(oc)} alta (risco de overflow).`); suggest.push(`Planejar ressuprimento/saídas e realocação de posições.`);} else{ push(warn,`Ocupação ${pct(oc)} baixa (subutilização).`); suggest.push(`Ajustar mix/entrada de clientes e uso de área.`);} }
  const t=k.turnover; if(!Number.isNaN(t)){ if(t<=THRESH.TURNOVER_WARN) push(good,`Turnover ${pct(t)} sob controle (≤ ${THRESH.TURNOVER_WARN}%).`); else if(t<=THRESH.TURNOVER_CRIT){ push(warn,`Turnover ${pct(t)} pede atenção.`); suggest.push(`Reter talentos críticos e reforçar treinamento.`);} else{ push(bad,`Turnover ${pct(t)} muito alto.`); suggest.push(`Plano de retenção e revisão de escalas/benefícios.`);} }
  const ab=k.absenteismo; if(!Number.isNaN(ab)){ if(ab<=THRESH.ABSENT_WARN) push(good,`Absenteísmo ${pct(ab)} ok (≤ ${THRESH.ABSENT_WARN}%).`); else if(ab<=THRESH.ABSENT_CRIT){ push(warn,`Absenteísmo ${pct(ab)} elevado.`); suggest.push(`Acompanhar faltas reincidentes e cobertura de turnos.`);} else{ push(bad,`Absenteísmo ${pct(ab)} crítico.`); suggest.push(`Ação imediata em clima, transporte e saúde ocupacional.`);} }
  return {good,warn,bad,suggest};
}
function renderInsights(res){
  const root=document.getElementById('insightsContent');
  const sect=(title,cls,arr)=>arr.length?`<h3 class="${cls}" style="margin:.4rem 0 .2rem 0;font-weight:700">${title}</h3><ul class="list">${arr.map(x=>`<li>${x}</li>`).join('')}</ul>`:'';
  root.innerHTML=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:.5rem"><span class="chip">Leituras automáticas da tela</span><span class="chip">Sem envio de dados</span><span class="chip">Ajuste os limiares no script</span></div>${sect('✔︎ O que está bom','ok',res.good)}${sect('⚠︎ Pontos de atenção','warn',res.warn)}${sect('⛔ Riscos / críticos','bad',res.bad)}${sect('💡 Sugestões','',res.suggest)}<div style="margin-top:.8rem;font-size:12px;color:#475569">Dica: para leituras 100% precisas, adicione <span class="kbd">data-kpi</span> e <span class="kbd">data-value</span> nos cards.</div>`;
}
const btn=document.getElementById('btnInsights'); const panel=document.getElementById('panelInsights'); const closeBtn=document.getElementById('closeInsights');
async function runAnalysis(){ const kpis=getKPIs(); const res=analyze(kpis); renderInsights(res); }
btn.addEventListener('click',()=>{ panel.style.display=panel.style.display==='none'?'block':'none'; if(panel.style.display==='block') runAnalysis();});
closeBtn.addEventListener('click',()=> panel.style.display='none');
document.addEventListener('keydown',(e)=>{ if(e.altKey && (e.key==='i'||e.key==='I')) btn.click();});
})();
</script>
</body>
</html>
